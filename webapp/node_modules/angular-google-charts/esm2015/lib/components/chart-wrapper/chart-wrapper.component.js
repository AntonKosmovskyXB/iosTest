import { __rest } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, EventEmitter, Input, Output } from '@angular/core';
import { ReplaySubject } from 'rxjs';
import { ScriptLoaderService } from '../../services/script-loader.service';
import * as ɵngcc0 from '@angular/core';
export class ChartWrapperComponent {
    constructor(element, scriptLoaderService) {
        this.element = element;
        this.scriptLoaderService = scriptLoaderService;
        this.error = new EventEmitter();
        this.ready = new EventEmitter();
        this.select = new EventEmitter();
        this.wrapperReadySubject = new ReplaySubject(1);
        this.initialized = false;
    }
    get chart() {
        return this.chartWrapper.getChart();
    }
    get wrapperReady$() {
        return this.wrapperReadySubject.asObservable();
    }
    get chartWrapper() {
        if (!this.wrapper) {
            throw new Error('Cannot access the chart wrapper before initialization.');
        }
        return this.wrapper;
    }
    set chartWrapper(wrapper) {
        this.wrapper = wrapper;
        this.drawChart();
    }
    ngOnInit() {
        // We don't need to load any chart packages, the chart wrapper will handle this else for us
        this.scriptLoaderService.loadChartPackages().subscribe(() => {
            if (!this.specs) {
                this.specs = {};
            }
            const _a = this.specs, { containerId, container } = _a, specs = __rest(_a, ["containerId", "container"]);
            // Only ever create the wrapper once to allow animations to happen if something changes.
            this.wrapper = new google.visualization.ChartWrapper(Object.assign(Object.assign({}, specs), { container: this.element.nativeElement }));
            this.registerChartEvents();
            this.wrapperReadySubject.next(this.wrapper);
            this.drawChart();
            this.initialized = true;
        });
    }
    ngOnChanges(changes) {
        if (!this.initialized) {
            return;
        }
        if (changes.specs) {
            this.updateChart();
            this.drawChart();
        }
    }
    updateChart() {
        if (!this.specs) {
            // When creating the wrapper with empty specs, the google charts library will show an error
            // If we don't do this, a javascript error will be thrown, which is not as visible to the user
            this.specs = {};
        }
        // The typing here are not correct. These methods accept `undefined` as well.
        // That's why we have to cast to `any`
        this.wrapper.setChartType(this.specs.chartType);
        this.wrapper.setDataTable(this.specs.dataTable);
        this.wrapper.setDataSourceUrl(this.specs.dataSourceUrl);
        this.wrapper.setDataSourceUrl(this.specs.dataSourceUrl);
        this.wrapper.setQuery(this.specs.query);
        this.wrapper.setOptions(this.specs.options);
        this.wrapper.setRefreshInterval(this.specs.refreshInterval);
        this.wrapper.setView(this.specs.view);
    }
    drawChart() {
        if (this.wrapper) {
            this.wrapper.draw();
        }
    }
    registerChartEvents() {
        google.visualization.events.removeAllListeners(this.wrapper);
        const registerChartEvent = (object, eventName, callback) => {
            google.visualization.events.addListener(object, eventName, callback);
        };
        registerChartEvent(this.wrapper, 'ready', () => this.ready.emit({ chart: this.chart }));
        registerChartEvent(this.wrapper, 'error', (error) => this.error.emit(error));
        registerChartEvent(this.wrapper, 'select', () => {
            const selection = this.chart.getSelection();
            this.select.emit({ selection });
        });
    }
}
ChartWrapperComponent.ɵfac = function ChartWrapperComponent_Factory(t) { return new (t || ChartWrapperComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ScriptLoaderService)); };
ChartWrapperComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: ChartWrapperComponent, selectors: [["chart-wrapper"]], hostAttrs: [1, "chart-wrapper"], inputs: { specs: "specs" }, outputs: { error: "error", ready: "ready", select: "select" }, exportAs: ["chartWrapper"], features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 0, vars: 0, template: function ChartWrapperComponent_Template(rf, ctx) { }, styles: ["[_nghost-%COMP%] { width: fit-content; display: block; }"], changeDetection: 0 });
ChartWrapperComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ScriptLoaderService }
];
ChartWrapperComponent.propDecorators = {
    specs: [{ type: Input }],
    error: [{ type: Output }],
    ready: [{ type: Output }],
    select: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ChartWrapperComponent, [{
        type: Component,
        args: [{
                selector: 'chart-wrapper',
                template: '',
                host: { class: 'chart-wrapper' },
                exportAs: 'chartWrapper',
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [':host { width: fit-content; display: block; }']
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ScriptLoaderService }]; }, { error: [{
            type: Output
        }], ready: [{
            type: Output
        }], select: [{
            type: Output
        }], specs: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhcnQtd3JhcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYW5ndWxhci1nb29nbGUtY2hhcnRzL3NyYy9saWIvY29tcG9uZW50cy9jaGFydC13cmFwcGVyL2NoYXJ0LXdyYXBwZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFHTCxNQUFNLEVBRVAsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVyQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQzs7QUFZM0UsTUFBTSxPQUFPLHFCQUFxQjtBQUFHLElBeUJuQyxZQUFvQixPQUFtQixFQUFVLG1CQUF3QztBQUFJLFFBQXpFLFlBQU8sR0FBUCxPQUFPLENBQVk7QUFBQyxRQUFTLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7QUFBQyxRQVpuRixVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7QUFDckQsUUFFUyxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7QUFDckQsUUFFUyxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQThCLENBQUM7QUFDakUsUUFFVSx3QkFBbUIsR0FBRyxJQUFJLGFBQWEsQ0FBb0MsQ0FBQyxDQUFDLENBQUM7QUFDeEYsUUFBVSxnQkFBVyxHQUFHLEtBQUssQ0FBQztBQUM5QixJQUM4RixDQUFDO0FBQy9GLElBQ0UsSUFBVyxLQUFLO0FBQUssUUFDbkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3hDLElBQUUsQ0FBQztBQUNILElBQ0UsSUFBVyxhQUFhO0FBQzFCLFFBQUksT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDbkQsSUFBRSxD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QUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRTtBQUNwRCxZQUFNLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDbkQsWUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7QUFDdEMsUUFBSSxDQUFDLENBQUMsQ0FBQztBQUNQLElBQUUsQ0FBQztBQUNIO2lEQWxJQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLGVBQWUsa0JBQ3pCLFFBQVEsRUFBRSxFQUFFLGtCQUVaLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsa0JBQ2hDO09BQVEsRUFBRSxjQUFjLGtCQUN4QixlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTSwyQkFIdEMsK0NBQStDLGVBSXpELG9UQUNJO0FBQUM7QUFBK0MsWUF0Qm5ELFVBQVU7QUFDVixZQVNPLG1CQUFtQjtBQUFHO0FBQUc7QUFBeUMsb0JBcUJ4RSxLQUFLO0FBQ04sb0JBRUMsTUFBTTtBQUNQLG9CQUVDLE1BQU07QUFDUCxxQkFFQyxNQUFNO0FBQ1I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IFNjcmlwdExvYWRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9zY3JpcHQtbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2hhcnRFcnJvckV2ZW50LCBDaGFydFJlYWR5RXZlbnQsIENoYXJ0U2VsZWN0aW9uQ2hhbmdlZEV2ZW50IH0gZnJvbSAnLi4vLi4vdHlwZXMvZXZlbnRzJztcbmltcG9ydCB7IENoYXJ0QmFzZSB9IGZyb20gJy4uL2NoYXJ0LWJhc2UvY2hhcnQtYmFzZS5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjaGFydC13cmFwcGVyJyxcbiAgdGVtcGxhdGU6ICcnLFxuICBzdHlsZXM6IFsnOmhvc3QgeyB3aWR0aDogZml0LWNvbnRlbnQ7IGRpc3BsYXk6IGJsb2NrOyB9J10sXG4gIGhvc3Q6IHsgY2xhc3M6ICdjaGFydC13cmFwcGVyJyB9LFxuICBleHBvcnRBczogJ2NoYXJ0V3JhcHBlcicsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIENoYXJ0V3JhcHBlckNvbXBvbmVudCBpbXBsZW1lbnRzIENoYXJ0QmFzZSwgT25DaGFuZ2VzLCBPbkluaXQge1xuICAvKipcbiAgICogRWl0aGVyIGEgSlNPTiBvYmplY3QgZGVmaW5pbmcgdGhlIGNoYXJ0LCBvciBhIHNlcmlhbGl6ZWQgc3RyaW5nIHZlcnNpb24gb2YgdGhhdCBvYmplY3QuXG4gICAqIFRoZSBmb3JtYXQgb2YgdGhpcyBvYmplY3QgaXMgc2hvd24gaW4gdGhlXG4gICAqIHtAbGluayBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaGFydC9pbnRlcmFjdGl2ZS9kb2NzL3JlZmVyZW5jZSNnb29nbGUudmlzdWFsaXphdGlvbi5kcmF3Y2hhcnQgYGRyYXdDaGFydCgpYH0gZG9jdW1lbnRhdGlvbi5cbiAgICpcbiAgICogVGhlIGBjb250YWluZXJgIGFuZCBgY29udGFpbmVySWRgIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgdGhpcyBjb21wb25lbnQgdG8gYWxsb3dcbiAgICogcmVuZGVyaW5nIHRoZSBjaGFydCBpbnRvIHRoZSBjb21wb25lbnRzJyB0ZW1wbGF0ZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzcGVjcz86IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0U3BlY3M7XG5cbiAgQE91dHB1dCgpXG4gIHB1YmxpYyBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8Q2hhcnRFcnJvckV2ZW50PigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgcmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyPENoYXJ0UmVhZHlFdmVudD4oKTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIHNlbGVjdCA9IG5ldyBFdmVudEVtaXR0ZXI8Q2hhcnRTZWxlY3Rpb25DaGFuZ2VkRXZlbnQ+KCk7XG5cbiAgcHJpdmF0ZSB3cmFwcGVyOiBnb29nbGUudmlzdWFsaXphdGlvbi5DaGFydFdyYXBwZXIgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgd3JhcHBlclJlYWR5U3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcj4oMSk7XG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIHByaXZhdGUgc2NyaXB0TG9hZGVyU2VydmljZTogU2NyaXB0TG9hZGVyU2VydmljZSkge31cblxuICBwdWJsaWMgZ2V0IGNoYXJ0KCk6IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0QmFzZSB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmNoYXJ0V3JhcHBlci5nZXRDaGFydCgpO1xuICB9XG5cbiAgcHVibGljIGdldCB3cmFwcGVyUmVhZHkkKCkge1xuICAgIHJldHVybiB0aGlzLndyYXBwZXJSZWFkeVN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGNoYXJ0V3JhcHBlcigpOiBnb29nbGUudmlzdWFsaXphdGlvbi5DaGFydFdyYXBwZXIge1xuICAgIGlmICghdGhpcy53cmFwcGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhY2Nlc3MgdGhlIGNoYXJ0IHdyYXBwZXIgYmVmb3JlIGluaXRpYWxpemF0aW9uLicpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLndyYXBwZXI7XG4gIH1cblxuICBwdWJsaWMgc2V0IGNoYXJ0V3JhcHBlcih3cmFwcGVyOiBnb29nbGUudmlzdWFsaXphdGlvbi5DaGFydFdyYXBwZXIpIHtcbiAgICB0aGlzLndyYXBwZXIgPSB3cmFwcGVyO1xuICAgIHRoaXMuZHJhd0NoYXJ0KCk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkluaXQoKSB7XG4gICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBsb2FkIGFueSBjaGFydCBwYWNrYWdlcywgdGhlIGNoYXJ0IHdyYXBwZXIgd2lsbCBoYW5kbGUgdGhpcyBlbHNlIGZvciB1c1xuICAgIHRoaXMuc2NyaXB0TG9hZGVyU2VydmljZS5sb2FkQ2hhcnRQYWNrYWdlcygpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuc3BlY3MpIHtcbiAgICAgICAgdGhpcy5zcGVjcyA9IHt9IGFzIGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0U3BlY3M7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgY29udGFpbmVySWQsIGNvbnRhaW5lciwgLi4uc3BlY3MgfSA9IHRoaXMuc3BlY3M7XG5cbiAgICAgIC8vIE9ubHkgZXZlciBjcmVhdGUgdGhlIHdyYXBwZXIgb25jZSB0byBhbGxvdyBhbmltYXRpb25zIHRvIGhhcHBlbiBpZiBzb21ldGhpbmcgY2hhbmdlcy5cbiAgICAgIHRoaXMud3JhcHBlciA9IG5ldyBnb29nbGUudmlzdWFsaXphdGlvbi5DaGFydFdyYXBwZXIoe1xuICAgICAgICAuLi5zcGVjcyxcbiAgICAgICAgY29udGFpbmVyOiB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudFxuICAgICAgfSk7XG4gICAgICB0aGlzLnJlZ2lzdGVyQ2hhcnRFdmVudHMoKTtcblxuICAgICAgdGhpcy53cmFwcGVyUmVhZHlTdWJqZWN0Lm5leHQodGhpcy53cmFwcGVyKTtcblxuICAgICAgdGhpcy5kcmF3Q2hhcnQoKTtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5zcGVjcykge1xuICAgICAgdGhpcy51cGRhdGVDaGFydCgpO1xuICAgICAgdGhpcy5kcmF3Q2hhcnQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUNoYXJ0KCkge1xuICAgIGlmICghdGhpcy5zcGVjcykge1xuICAgICAgLy8gV2hlbiBjcmVhdGluZyB0aGUgd3JhcHBlciB3aXRoIGVtcHR5IHNwZWNzLCB0aGUgZ29vZ2xlIGNoYXJ0cyBsaWJyYXJ5IHdpbGwgc2hvdyBhbiBlcnJvclxuICAgICAgLy8gSWYgd2UgZG9uJ3QgZG8gdGhpcywgYSBqYXZhc2NyaXB0IGVycm9yIHdpbGwgYmUgdGhyb3duLCB3aGljaCBpcyBub3QgYXMgdmlzaWJsZSB0byB0aGUgdXNlclxuICAgICAgdGhpcy5zcGVjcyA9IHt9IGFzIGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0U3BlY3M7XG4gICAgfVxuXG4gICAgLy8gVGhlIHR5cGluZyBoZXJlIGFyZSBub3QgY29ycmVjdC4gVGhlc2UgbWV0aG9kcyBhY2NlcHQgYHVuZGVmaW5lZGAgYXMgd2VsbC5cbiAgICAvLyBUaGF0J3Mgd2h5IHdlIGhhdmUgdG8gY2FzdCB0byBgYW55YFxuXG4gICAgdGhpcy53cmFwcGVyIS5zZXRDaGFydFR5cGUodGhpcy5zcGVjcy5jaGFydFR5cGUpO1xuICAgIHRoaXMud3JhcHBlciEuc2V0RGF0YVRhYmxlKHRoaXMuc3BlY3MuZGF0YVRhYmxlIGFzIGFueSk7XG4gICAgdGhpcy53cmFwcGVyIS5zZXREYXRhU291cmNlVXJsKHRoaXMuc3BlY3MuZGF0YVNvdXJjZVVybCBhcyBhbnkpO1xuICAgIHRoaXMud3JhcHBlciEuc2V0RGF0YVNvdXJjZVVybCh0aGlzLnNwZWNzLmRhdGFTb3VyY2VVcmwgYXMgYW55KTtcbiAgICB0aGlzLndyYXBwZXIhLnNldFF1ZXJ5KHRoaXMuc3BlY3MucXVlcnkgYXMgYW55KTtcbiAgICB0aGlzLndyYXBwZXIhLnNldE9wdGlvbnModGhpcy5zcGVjcy5vcHRpb25zIGFzIGFueSk7XG4gICAgdGhpcy53cmFwcGVyIS5zZXRSZWZyZXNoSW50ZXJ2YWwodGhpcy5zcGVjcy5yZWZyZXNoSW50ZXJ2YWwgYXMgYW55KTtcbiAgICB0aGlzLndyYXBwZXIhLnNldFZpZXcodGhpcy5zcGVjcy52aWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgZHJhd0NoYXJ0KCkge1xuICAgIGlmICh0aGlzLndyYXBwZXIpIHtcbiAgICAgIHRoaXMud3JhcHBlci5kcmF3KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlckNoYXJ0RXZlbnRzKCkge1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5yZW1vdmVBbGxMaXN0ZW5lcnModGhpcy53cmFwcGVyKTtcblxuICAgIGNvbnN0IHJlZ2lzdGVyQ2hhcnRFdmVudCA9IChvYmplY3Q6IGFueSwgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKG9iamVjdCwgZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgfTtcblxuICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLndyYXBwZXIsICdyZWFkeScsICgpID0+IHRoaXMucmVhZHkuZW1pdCh7IGNoYXJ0OiB0aGlzLmNoYXJ0ISB9KSk7XG4gICAgcmVnaXN0ZXJDaGFydEV2ZW50KHRoaXMud3JhcHBlciwgJ2Vycm9yJywgKGVycm9yOiBDaGFydEVycm9yRXZlbnQpID0+IHRoaXMuZXJyb3IuZW1pdChlcnJvcikpO1xuICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLndyYXBwZXIsICdzZWxlY3QnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSB0aGlzLmNoYXJ0IS5nZXRTZWxlY3Rpb24oKTtcbiAgICAgIHRoaXMuc2VsZWN0LmVtaXQoeyBzZWxlY3Rpb24gfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==