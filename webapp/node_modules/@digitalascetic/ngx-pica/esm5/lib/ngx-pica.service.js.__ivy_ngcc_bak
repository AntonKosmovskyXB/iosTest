import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { NgxPicaErrorType } from './ngx-pica-error.interface';
import { NgxPicaExifService } from './ngx-pica-exif.service';
import Pica from 'pica';
import { switchMap } from "rxjs/operators";
var NgxPicaService = /** @class */ (function () {
    function NgxPicaService(_ngxPicaExifService) {
        this._ngxPicaExifService = _ngxPicaExifService;
        this.picaResizer = new Pica();
        this.MAX_STEPS = 20;
        if (!this.picaResizer || !this.picaResizer.resize) {
            this.picaResizer = new window.Pica();
        }
    }
    NgxPicaService.prototype.resizeImages = function (files, width, height, options) {
        var _this = this;
        var resizedImage = new Subject();
        var totalFiles = files.length;
        if (totalFiles > 0) {
            var nextFile_1 = new Subject();
            var index_1 = 0;
            var subscription_1 = nextFile_1
                .pipe(switchMap(function (file) { return _this.resizeImage(file, width, height, options); }))
                .subscribe(function (imageResized) {
                index_1++;
                resizedImage.next(imageResized);
                if (index_1 < totalFiles) {
                    nextFile_1.next(files[index_1]);
                }
                else {
                    resizedImage.complete();
                    subscription_1.unsubscribe();
                }
            }, function (err) {
                var ngxPicaError = {
                    file: files[index_1],
                    err: err
                };
                resizedImage.error(ngxPicaError);
            });
            nextFile_1.next(files[index_1]);
        }
        else {
            var ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            resizedImage.error(ngxPicaError);
            resizedImage.complete();
        }
        return resizedImage.asObservable();
    };
    NgxPicaService.prototype.resizeImage = function (file, width, height, options) {
        var _this = this;
        var resizedImage = new Subject();
        var originCanvas = document.createElement('canvas');
        var ctx = originCanvas.getContext('2d');
        var img = new Image();
        var reader = new FileReader();
        if (!options) {
            options = {
                exifOptions: {
                    forceExifOrientation: true
                }
            };
        }
        if (ctx) {
            reader.addEventListener('load', function (event) {
                img.onerror = function (err) {
                    resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                };
                img.onload = function () {
                    _this.processImageExifOptions(img, options.exifOptions)
                        .then(function (orientedImage) {
                        originCanvas.width = orientedImage.width;
                        originCanvas.height = orientedImage.height;
                        ctx.drawImage(orientedImage, 0, 0);
                        var imageData = ctx.getImageData(0, 0, orientedImage.width, orientedImage.height);
                        if (options && options.aspectRatio && options.aspectRatio.keepAspectRatio) {
                            var ratio = 0;
                            if (options.aspectRatio.forceMinDimensions) {
                                ratio = Math.max(width / imageData.width, height / imageData.height);
                            }
                            else {
                                ratio = Math.min(width / imageData.width, height / imageData.height);
                            }
                            width = Math.round(imageData.width * ratio);
                            height = Math.round(imageData.height * ratio);
                        }
                        var destinationCanvas = document.createElement('canvas');
                        destinationCanvas.width = width;
                        destinationCanvas.height = height;
                        _this.picaResize(file, originCanvas, destinationCanvas, options)
                            .catch(function (err) { return resizedImage.error(err); })
                            .then(function (imgResized) {
                            resizedImage.next(imgResized);
                            resizedImage.complete();
                        });
                    })
                        .catch(function (err) {
                        resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                    });
                };
                img.src = reader.result;
            });
            reader.readAsDataURL(file);
        }
        else {
            resizedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
        }
        return resizedImage.asObservable();
    };
    NgxPicaService.prototype.compressImages = function (files, sizeInMB, options) {
        var _this = this;
        var compressedImage = new Subject();
        var totalFiles = files.length;
        if (totalFiles > 0) {
            var nextFile_2 = new Subject();
            var index_2 = 0;
            var subscription_2 = nextFile_2
                .pipe(switchMap(function (file) { return _this.compressImage(file, sizeInMB, options); }))
                .subscribe(function (imageCompressed) {
                index_2++;
                compressedImage.next(imageCompressed);
                if (index_2 < totalFiles) {
                    nextFile_2.next(files[index_2]);
                }
                else {
                    compressedImage.complete();
                    subscription_2.unsubscribe();
                }
            }, function (err) {
                var ngxPicaError = {
                    file: files[index_2],
                    err: err
                };
                compressedImage.error(ngxPicaError);
            });
            nextFile_2.next(files[index_2]);
        }
        else {
            var ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            compressedImage.error(ngxPicaError);
            compressedImage.complete();
        }
        return compressedImage.asObservable();
    };
    NgxPicaService.prototype.compressImage = function (file, sizeInMB, options) {
        var _this = this;
        var compressedImage = new Subject();
        if (this.bytesToMB(file.size) <= sizeInMB) {
            setTimeout(function () {
                compressedImage.next(file);
                compressedImage.complete();
            });
        }
        else {
            var originCanvas_1 = document.createElement('canvas');
            var ctx_1 = originCanvas_1.getContext('2d');
            var img_1 = new Image();
            var reader_1 = new FileReader();
            if (!options) {
                options = {
                    exifOptions: {
                        forceExifOrientation: true
                    }
                };
            }
            if (ctx_1) {
                reader_1.addEventListener('load', function (event) {
                    img_1.onload = function () {
                        _this.processImageExifOptions(img_1, options.exifOptions)
                            .then(function (orientedImage) {
                            originCanvas_1.width = orientedImage.width;
                            originCanvas_1.height = orientedImage.height;
                            ctx_1.drawImage(orientedImage, 0, 0);
                            _this.getCompressedImage(originCanvas_1, file.type, 1, sizeInMB, 0)
                                .catch(function (err) { return compressedImage.error(err); })
                                .then(function (blob) {
                                var imgCompressed = _this.blobToFile(blob, file.name, file.type, new Date().getTime());
                                compressedImage.next(imgCompressed);
                                compressedImage.complete();
                            });
                        });
                    };
                    img_1.src = reader_1.result;
                });
                reader_1.readAsDataURL(file);
            }
            else {
                compressedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
            }
        }
        return compressedImage.asObservable();
    };
    NgxPicaService.prototype.processImageExifOptions = function (img, exifOptions) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (exifOptions.forceExifOrientation) {
                _this._ngxPicaExifService.getExifOrientedImage(img)
                    .then(function (orientedImage) { return resolve(orientedImage); })
                    .catch(function (err) { return reject(err); });
            }
            else {
                resolve(img);
            }
        });
    };
    NgxPicaService.prototype.getCompressedImage = function (canvas, type, quality, sizeInMB, step) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.picaResizer.toBlob(canvas, type, quality)
                .catch(function (err) { return reject(err); })
                .then(function (blob) {
                _this.checkCompressedImageSize(canvas, blob, quality, sizeInMB, step)
                    .catch(function (err) { return reject(err); })
                    .then(function (compressedBlob) {
                    resolve(compressedBlob);
                });
            });
        });
    };
    NgxPicaService.prototype.checkCompressedImageSize = function (canvas, blob, quality, sizeInMB, step) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (step > _this.MAX_STEPS) {
                reject(NgxPicaErrorType.NOT_BE_ABLE_TO_COMPRESS_ENOUGH);
            }
            else if (_this.bytesToMB(blob.size) < sizeInMB) {
                resolve(blob);
            }
            else {
                var newQuality = quality - (quality * 0.1);
                var newStep = step + 1;
                // recursively compression
                resolve(_this.getCompressedImage(canvas, blob.type, newQuality, sizeInMB, newStep));
            }
        });
    };
    NgxPicaService.prototype.picaResize = function (file, from, to, options) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.picaResizer.resize(from, to, options)
                .catch(function (err) { return reject(err); })
                .then(function (resizedCanvas) { return _this.picaResizer.toBlob(resizedCanvas, file.type); })
                .then(function (blob) {
                var fileResized = _this.blobToFile(blob, file.name, file.type, new Date().getTime());
                resolve(fileResized);
            });
        });
    };
    NgxPicaService.prototype.blobToFile = function (blob, name, type, lastModified) {
        return Object.assign(new Blob([blob], { type: type }), { name: name, lastModified: lastModified });
    };
    NgxPicaService.prototype.bytesToMB = function (bytes) {
        return bytes / 1048576;
    };
    NgxPicaService.ctorParameters = function () { return [
        { type: NgxPicaExifService }
    ]; };
    NgxPicaService = __decorate([
        Injectable(),
        __metadata("design:paramtypes", [NgxPicaExifService])
    ], NgxPicaService);
    return NgxPicaService;
}());
export { NgxPicaService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBpY2Euc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkaWdpdGFsYXNjZXRpYy9uZ3gtcGljYS8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtcGljYS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxPQUFPLEVBQTJCLE1BQU0sTUFBTSxDQUFDO0FBQ3ZELE9BQU8sRUFBd0IsZ0JBQWdCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQU1uRixPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBTXpDO0lBSUUsd0JBQW9CLG1CQUF1QztRQUF2Qyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQW9CO1FBSG5ELGdCQUFXLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN6QixjQUFTLEdBQUcsRUFBRSxDQUFDO1FBR3JCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUU7WUFDakQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUN0QztJQUNILENBQUM7SUFFTSxxQ0FBWSxHQUFuQixVQUFvQixLQUFhLEVBQUUsS0FBYSxFQUFFLE1BQWMsRUFBRSxPQUF1QztRQUF6RyxpQkEyQ0M7UUExQ0MsSUFBTSxZQUFZLEdBQWtCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDbEQsSUFBTSxVQUFVLEdBQVcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUV4QyxJQUFJLFVBQVUsR0FBRyxDQUFDLEVBQUU7WUFDbEIsSUFBTSxVQUFRLEdBQWtCLElBQUksT0FBTyxFQUFFLENBQUM7WUFDOUMsSUFBSSxP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Q3ZCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sbUNBQVUsR0FBbEIsVUFBbUIsSUFBVSxFQUFFLElBQVksRUFBRSxJQUFZLEVBQUUsWUFBb0I7UUFDN0UsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsRUFBRSxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7SUFDakcsQ0FBQztJQUVPLGtDQUFTLEdBQWpCLFVBQWtCLEtBQWE7UUFDN0IsT0FBTyxLQUFLLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7O2dCQW5Td0Msa0JBQWtCOztJQUpoRCxjQUFjO1FBRDFCLFVBQVUsRUFBRTt5Q0FLOEIsa0JBQWtCO09BSmhELGNBQWMsQ0F3UzFCO0lBQUQscUJBQUM7Q0FBQSxBQXhTRCxJQXdTQztTQXhTWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7U3ViamVjdCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcbmltcG9ydCB7Tmd4UGljYUVycm9ySW50ZXJmYWNlLCBOZ3hQaWNhRXJyb3JUeXBlfSBmcm9tICcuL25neC1waWNhLWVycm9yLmludGVyZmFjZSc7XG5pbXBvcnQge1xuICBFeGlmT3B0aW9ucyxcbiAgTmd4UGljYUNvbXByZXNzT3B0aW9uc0ludGVyZmFjZSxcbiAgTmd4UGljYVJlc2l6ZU9wdGlvbnNJbnRlcmZhY2Vcbn0gZnJvbSAnLi9uZ3gtcGljYS1yZXNpemUtb3B0aW9ucy5pbnRlcmZhY2UnO1xuaW1wb3J0IHtOZ3hQaWNhRXhpZlNlcnZpY2V9IGZyb20gJy4vbmd4LXBpY2EtZXhpZi5zZXJ2aWNlJztcbmltcG9ydCBQaWNhIGZyb20gJ3BpY2EnO1xuaW1wb3J0IHtzd2l0Y2hNYXB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuXG5cbmRlY2xhcmUgbGV0IHdpbmRvdzogYW55O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmd4UGljYVNlcnZpY2Uge1xuICBwcml2YXRlIHBpY2FSZXNpemVyID0gbmV3IFBpY2EoKTtcbiAgcHJpdmF0ZSBNQVhfU1RFUFMgPSAyMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9uZ3hQaWNhRXhpZlNlcnZpY2U6IE5neFBpY2FFeGlmU2VydmljZSkge1xuICAgIGlmICghdGhpcy5waWNhUmVzaXplciB8fCAhdGhpcy5waWNhUmVzaXplci5yZXNpemUpIHtcbiAgICAgIHRoaXMucGljYVJlc2l6ZXIgPSBuZXcgd2luZG93LlBpY2EoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVzaXplSW1hZ2VzKGZpbGVzOiBGaWxlW10sIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBvcHRpb25zPzogTmd4UGljYVJlc2l6ZU9wdGlvbnNJbnRlcmZhY2UpOiBPYnNlcnZhYmxlPEZpbGU+IHtcbiAgICBjb25zdCByZXNpemVkSW1hZ2U6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgIGNvbnN0IHRvdGFsRmlsZXM6IG51bWJlciA9IGZpbGVzLmxlbmd0aDtcblxuICAgIGlmICh0b3RhbEZpbGVzID4gMCkge1xuICAgICAgY29uc3QgbmV4dEZpbGU6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgbGV0IGluZGV4ID0gMDtcblxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBuZXh0RmlsZVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKGZpbGU6IEZpbGUpID0+IHRoaXMucmVzaXplSW1hZ2UoZmlsZSwgd2lkdGgsIGhlaWdodCwgb3B0aW9ucykpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShpbWFnZVJlc2l6ZWQgPT4ge1xuICAgICAgICAgIGluZGV4Kys7XG4gICAgICAgICAgcmVzaXplZEltYWdlLm5leHQoaW1hZ2VSZXNpemVkKTtcblxuICAgICAgICAgIGlmIChpbmRleCA8IHRvdGFsRmlsZXMpIHtcbiAgICAgICAgICAgIG5leHRGaWxlLm5leHQoZmlsZXNbaW5kZXhdKTtcblxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNpemVkSW1hZ2UuY29tcGxldGUoKTtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIGNvbnN0IG5neFBpY2FFcnJvcjogTmd4UGljYUVycm9ySW50ZXJmYWNlID0ge1xuICAgICAgICAgICAgZmlsZTogZmlsZXNbaW5kZXhdLFxuICAgICAgICAgICAgZXJyOiBlcnJcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgcmVzaXplZEltYWdlLmVycm9yKG5neFBpY2FFcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICBuZXh0RmlsZS5uZXh0KGZpbGVzW2luZGV4XSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5neFBpY2FFcnJvcjogTmd4UGljYUVycm9ySW50ZXJmYWNlID0ge1xuICAgICAgICBlcnI6IE5neFBpY2FFcnJvclR5cGUuTk9fRklMRVNfUkVDRUlWRURcbiAgICAgIH07XG5cbiAgICAgIHJlc2l6ZWRJbWFnZS5lcnJvcihuZ3hQaWNhRXJyb3IpO1xuICAgICAgcmVzaXplZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc2l6ZWRJbWFnZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyByZXNpemVJbWFnZShmaWxlOiBGaWxlLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgb3B0aW9ucz86IE5neFBpY2FSZXNpemVPcHRpb25zSW50ZXJmYWNlKTogT2JzZXJ2YWJsZTxGaWxlPiB7XG4gICAgY29uc3QgcmVzaXplZEltYWdlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBjb25zdCBvcmlnaW5DYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgY29uc3QgY3R4ID0gb3JpZ2luQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG4gICAgY29uc3QgcmVhZGVyOiBGaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcblxuICAgIGlmICghb3B0aW9ucykge1xuICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgZXhpZk9wdGlvbnM6IHtcbiAgICAgICAgICBmb3JjZUV4aWZPcmllbnRhdGlvbjogdHJ1ZVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChjdHgpIHtcbiAgICAgIHJlYWRlci5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgaW1nLm9uZXJyb3IgPSAoZXJyKSA9PiB7XG4gICAgICAgICAgcmVzaXplZEltYWdlLmVycm9yKHtlcnI6IE5neFBpY2FFcnJvclR5cGUuUkVBRF9FUlJPUiwgZmlsZTogZmlsZSwgb3JpZ2luYWxfZXJyb3I6IGVycn0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5wcm9jZXNzSW1hZ2VFeGlmT3B0aW9ucyhpbWcsIG9wdGlvbnMuZXhpZk9wdGlvbnMpXG4gICAgICAgICAgICAudGhlbihvcmllbnRlZEltYWdlID0+IHtcbiAgICAgICAgICAgICAgb3JpZ2luQ2FudmFzLndpZHRoID0gb3JpZW50ZWRJbWFnZS53aWR0aDtcbiAgICAgICAgICAgICAgb3JpZ2luQ2FudmFzLmhlaWdodCA9IG9yaWVudGVkSW1hZ2UuaGVpZ2h0O1xuXG4gICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uob3JpZW50ZWRJbWFnZSwgMCwgMCk7XG5cbiAgICAgICAgICAgICAgY29uc3QgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCBvcmllbnRlZEltYWdlLndpZHRoLCBvcmllbnRlZEltYWdlLmhlaWdodCk7XG4gICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYXNwZWN0UmF0aW8gJiYgb3B0aW9ucy5hc3BlY3RSYXRpby5rZWVwQXNwZWN0UmF0aW8pIHtcbiAgICAgICAgICAgICAgICBsZXQgcmF0aW8gPSAwO1xuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXNwZWN0UmF0aW8uZm9yY2VNaW5EaW1lbnNpb25zKSB7XG4gICAgICAgICAgICAgICAgICByYXRpbyA9IE1hdGgubWF4KHdpZHRoIC8gaW1hZ2VEYXRhLndpZHRoLCBoZWlnaHQgLyBpbWFnZURhdGEuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmF0aW8gPSBNYXRoLm1pbih3aWR0aCAvIGltYWdlRGF0YS53aWR0aCwgaGVpZ2h0IC8gaW1hZ2VEYXRhLmhlaWdodCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgd2lkdGggPSBNYXRoLnJvdW5kKGltYWdlRGF0YS53aWR0aCAqIHJhdGlvKTtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBNYXRoLnJvdW5kKGltYWdlRGF0YS5oZWlnaHQgKiByYXRpbyk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBjb25zdCBkZXN0aW5hdGlvbkNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgICAgICAgZGVzdGluYXRpb25DYW52YXMud2lkdGggPSB3aWR0aDtcbiAgICAgICAgICAgICAgZGVzdGluYXRpb25DYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gICAgICAgICAgICAgIHRoaXMucGljYVJlc2l6ZShmaWxlLCBvcmlnaW5DYW52YXMsIGRlc3RpbmF0aW9uQ2FudmFzLCBvcHRpb25zKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZXNpemVkSW1hZ2UuZXJyb3IoZXJyKSlcbiAgICAgICAgICAgICAgICAudGhlbigoaW1nUmVzaXplZDogRmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgcmVzaXplZEltYWdlLm5leHQoaW1nUmVzaXplZCk7XG4gICAgICAgICAgICAgICAgICByZXNpemVkSW1hZ2UuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICByZXNpemVkSW1hZ2UuZXJyb3Ioe2VycjogTmd4UGljYUVycm9yVHlwZS5SRUFEX0VSUk9SLCBmaWxlOiBmaWxlLCBvcmlnaW5hbF9lcnJvcjogZXJyfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICBpbWcuc3JjID0gPHN0cmluZz5yZWFkZXIucmVzdWx0O1xuICAgICAgfSk7XG5cbiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNpemVkSW1hZ2UuZXJyb3IoTmd4UGljYUVycm9yVHlwZS5DQU5WQVNfQ09OVEVYVF9JREVOVElGSUVSX05PVF9TVVBQT1JURUQpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNpemVkSW1hZ2UuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwdWJsaWMgY29tcHJlc3NJbWFnZXMoZmlsZXM6IEZpbGVbXSwgc2l6ZUluTUI6IG51bWJlciwgb3B0aW9ucz86IE5neFBpY2FDb21wcmVzc09wdGlvbnNJbnRlcmZhY2UpOiBPYnNlcnZhYmxlPEZpbGU+IHtcbiAgICBjb25zdCBjb21wcmVzc2VkSW1hZ2U6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgIGNvbnN0IHRvdGFsRmlsZXM6IG51bWJlciA9IGZpbGVzLmxlbmd0aDtcblxuICAgIGlmICh0b3RhbEZpbGVzID4gMCkge1xuICAgICAgY29uc3QgbmV4dEZpbGU6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgbGV0IGluZGV4ID0gMDtcblxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBuZXh0RmlsZVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKGZpbGU6IEZpbGUpID0+IHRoaXMuY29tcHJlc3NJbWFnZShmaWxlLCBzaXplSW5NQiwgb3B0aW9ucykpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShpbWFnZUNvbXByZXNzZWQgPT4ge1xuICAgICAgICAgIGluZGV4Kys7XG4gICAgICAgICAgY29tcHJlc3NlZEltYWdlLm5leHQoaW1hZ2VDb21wcmVzc2VkKTtcblxuICAgICAgICAgIGlmIChpbmRleCA8IHRvdGFsRmlsZXMpIHtcbiAgICAgICAgICAgIG5leHRGaWxlLm5leHQoZmlsZXNbaW5kZXhdKTtcblxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb21wcmVzc2VkSW1hZ2UuY29tcGxldGUoKTtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIGNvbnN0IG5neFBpY2FFcnJvcjogTmd4UGljYUVycm9ySW50ZXJmYWNlID0ge1xuICAgICAgICAgICAgZmlsZTogZmlsZXNbaW5kZXhdLFxuICAgICAgICAgICAgZXJyOiBlcnJcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgY29tcHJlc3NlZEltYWdlLmVycm9yKG5neFBpY2FFcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICBuZXh0RmlsZS5uZXh0KGZpbGVzW2luZGV4XSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5neFBpY2FFcnJvcjogTmd4UGljYUVycm9ySW50ZXJmYWNlID0ge1xuICAgICAgICBlcnI6IE5neFBpY2FFcnJvclR5cGUuTk9fRklMRVNfUkVDRUlWRURcbiAgICAgIH07XG5cbiAgICAgIGNvbXByZXNzZWRJbWFnZS5lcnJvcihuZ3hQaWNhRXJyb3IpO1xuICAgICAgY29tcHJlc3NlZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXByZXNzZWRJbWFnZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBjb21wcmVzc0ltYWdlKGZpbGU6IEZpbGUsIHNpemVJbk1COiBudW1iZXIsIG9wdGlvbnM/OiBOZ3hQaWNhQ29tcHJlc3NPcHRpb25zSW50ZXJmYWNlKTogT2JzZXJ2YWJsZTxGaWxlPiB7XG4gICAgY29uc3QgY29tcHJlc3NlZEltYWdlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIGlmICh0aGlzLmJ5dGVzVG9NQihmaWxlLnNpemUpIDw9IHNpemVJbk1CKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29tcHJlc3NlZEltYWdlLm5leHQoZmlsZSk7XG4gICAgICAgIGNvbXByZXNzZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcblxuICAgICAgY29uc3Qgb3JpZ2luQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgY29uc3QgY3R4ID0gb3JpZ2luQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgIGNvbnN0IHJlYWRlcjogRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG5cbiAgICAgIGlmICghb3B0aW9ucykge1xuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIGV4aWZPcHRpb25zOiB7XG4gICAgICAgICAgICBmb3JjZUV4aWZPcmllbnRhdGlvbjogdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKGN0eCkge1xuICAgICAgICByZWFkZXIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0ltYWdlRXhpZk9wdGlvbnMoaW1nLCBvcHRpb25zLmV4aWZPcHRpb25zKVxuICAgICAgICAgICAgICAudGhlbihvcmllbnRlZEltYWdlID0+IHtcbiAgICAgICAgICAgICAgICBvcmlnaW5DYW52YXMud2lkdGggPSBvcmllbnRlZEltYWdlLndpZHRoO1xuICAgICAgICAgICAgICAgIG9yaWdpbkNhbnZhcy5oZWlnaHQgPSBvcmllbnRlZEltYWdlLmhlaWdodDtcblxuICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uob3JpZW50ZWRJbWFnZSwgMCwgMCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmdldENvbXByZXNzZWRJbWFnZShvcmlnaW5DYW52YXMsIGZpbGUudHlwZSwgMSwgc2l6ZUluTUIsIDApXG4gICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gY29tcHJlc3NlZEltYWdlLmVycm9yKGVycikpXG4gICAgICAgICAgICAgICAgICAudGhlbigoYmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbWdDb21wcmVzc2VkOiBGaWxlID0gdGhpcy5ibG9iVG9GaWxlKGJsb2IsIGZpbGUubmFtZSwgZmlsZS50eXBlLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29tcHJlc3NlZEltYWdlLm5leHQoaW1nQ29tcHJlc3NlZCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbXByZXNzZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICBpbWcuc3JjID0gPHN0cmluZz5yZWFkZXIucmVzdWx0O1xuICAgICAgICB9KTtcblxuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXByZXNzZWRJbWFnZS5lcnJvcihOZ3hQaWNhRXJyb3JUeXBlLkNBTlZBU19DT05URVhUX0lERU5USUZJRVJfTk9UX1NVUFBPUlRFRCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXByZXNzZWRJbWFnZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc0ltYWdlRXhpZk9wdGlvbnMoaW1nOiBIVE1MSW1hZ2VFbGVtZW50LCBleGlmT3B0aW9uczogRXhpZk9wdGlvbnMpOiBQcm9taXNlPEhUTUxJbWFnZUVsZW1lbnQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8SFRNTEltYWdlRWxlbWVudD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKGV4aWZPcHRpb25zLmZvcmNlRXhpZk9yaWVudGF0aW9uKSB7XG4gICAgICAgIHRoaXMuX25neFBpY2FFeGlmU2VydmljZS5nZXRFeGlmT3JpZW50ZWRJbWFnZShpbWcpXG4gICAgICAgICAgLnRoZW4ob3JpZW50ZWRJbWFnZSA9PiByZXNvbHZlKG9yaWVudGVkSW1hZ2UpKVxuICAgICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZShpbWcpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb21wcmVzc2VkSW1hZ2UoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCwgdHlwZTogc3RyaW5nLCBxdWFsaXR5OiBudW1iZXIsIHNpemVJbk1COiBudW1iZXIsIHN0ZXA6IG51bWJlcik6IFByb21pc2U8QmxvYj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxCbG9iPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnBpY2FSZXNpemVyLnRvQmxvYihjYW52YXMsIHR5cGUsIHF1YWxpdHkpXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSlcbiAgICAgICAgLnRoZW4oKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICB0aGlzLmNoZWNrQ29tcHJlc3NlZEltYWdlU2l6ZShjYW52YXMsIGJsb2IsIHF1YWxpdHksIHNpemVJbk1CLCBzdGVwKVxuICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgICAgICAgLnRoZW4oKGNvbXByZXNzZWRCbG9iOiBCbG9iKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShjb21wcmVzc2VkQmxvYik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0NvbXByZXNzZWRJbWFnZVNpemUoXG4gICAgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCxcbiAgICBibG9iOiBCbG9iLFxuICAgIHF1YWxpdHk6IG51bWJlcixcbiAgICBzaXplSW5NQjogbnVtYmVyLFxuICAgIHN0ZXA6IG51bWJlclxuICApOiBQcm9taXNlPEJsb2I+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8QmxvYj4oKHJlc29sdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QpID0+IHtcblxuICAgICAgaWYgKHN0ZXAgPiB0aGlzLk1BWF9TVEVQUykge1xuICAgICAgICByZWplY3QoTmd4UGljYUVycm9yVHlwZS5OT1RfQkVfQUJMRV9UT19DT01QUkVTU19FTk9VR0gpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmJ5dGVzVG9NQihibG9iLnNpemUpIDwgc2l6ZUluTUIpIHtcbiAgICAgICAgcmVzb2x2ZShibG9iKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5ld1F1YWxpdHk6IG51bWJlciA9IHF1YWxpdHkgLSAocXVhbGl0eSAqIDAuMSk7XG4gICAgICAgIGNvbnN0IG5ld1N0ZXA6IG51bWJlciA9IHN0ZXAgKyAxO1xuXG4gICAgICAgIC8vIHJlY3Vyc2l2ZWx5IGNvbXByZXNzaW9uXG4gICAgICAgIHJlc29sdmUodGhpcy5nZXRDb21wcmVzc2VkSW1hZ2UoY2FudmFzLCBibG9iLnR5cGUsIG5ld1F1YWxpdHksIHNpemVJbk1CLCBuZXdTdGVwKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHBpY2FSZXNpemUoZmlsZTogRmlsZSwgZnJvbTogSFRNTENhbnZhc0VsZW1lbnQsIHRvOiBIVE1MQ2FudmFzRWxlbWVudCwgb3B0aW9uczogYW55KTogUHJvbWlzZTxGaWxlPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEZpbGU+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucGljYVJlc2l6ZXIucmVzaXplKGZyb20sIHRvLCBvcHRpb25zKVxuICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpXG4gICAgICAgIC50aGVuKChyZXNpemVkQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCkgPT4gdGhpcy5waWNhUmVzaXplci50b0Jsb2IocmVzaXplZENhbnZhcywgZmlsZS50eXBlKSlcbiAgICAgICAgLnRoZW4oKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICBjb25zdCBmaWxlUmVzaXplZDogRmlsZSA9IHRoaXMuYmxvYlRvRmlsZShibG9iLCBmaWxlLm5hbWUsIGZpbGUudHlwZSwgbmV3IERhdGUoKS5nZXRUaW1lKCkpO1xuICAgICAgICAgIHJlc29sdmUoZmlsZVJlc2l6ZWQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYmxvYlRvRmlsZShibG9iOiBCbG9iLCBuYW1lOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgbGFzdE1vZGlmaWVkOiBudW1iZXIpOiBGaWxlIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgQmxvYihbYmxvYl0sIHt0eXBlOiB0eXBlfSksIHtuYW1lOiBuYW1lLCBsYXN0TW9kaWZpZWQ6IGxhc3RNb2RpZmllZH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBieXRlc1RvTUIoYnl0ZXM6IG51bWJlcikge1xuICAgIHJldHVybiBieXRlcyAvIDEwNDg1NzY7XG4gIH1cbn1cbiJdfQ==