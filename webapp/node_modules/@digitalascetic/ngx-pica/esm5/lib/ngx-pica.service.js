import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { NgxPicaErrorType } from './ngx-pica-error.interface';
import { NgxPicaExifService } from './ngx-pica-exif.service';
import Pica from 'pica';
import { switchMap } from "rxjs/operators";
import * as ɵngcc0 from '@angular/core';
var NgxPicaService = /** @class */ (function () {
    function NgxPicaService(_ngxPicaExifService) {
        this._ngxPicaExifService = _ngxPicaExifService;
        this.picaResizer = new Pica();
        this.MAX_STEPS = 20;
        if (!this.picaResizer || !this.picaResizer.resize) {
            this.picaResizer = new window.Pica();
        }
    }
    NgxPicaService.prototype.resizeImages = function (files, width, height, options) {
        var _this = this;
        var resizedImage = new Subject();
        var totalFiles = files.length;
        if (totalFiles > 0) {
            var nextFile_1 = new Subject();
            var index_1 = 0;
            var subscription_1 = nextFile_1
                .pipe(switchMap(function (file) { return _this.resizeImage(file, width, height, options); }))
                .subscribe(function (imageResized) {
                index_1++;
                resizedImage.next(imageResized);
                if (index_1 < totalFiles) {
                    nextFile_1.next(files[index_1]);
                }
                else {
                    resizedImage.complete();
                    subscription_1.unsubscribe();
                }
            }, function (err) {
                var ngxPicaError = {
                    file: files[index_1],
                    err: err
                };
                resizedImage.error(ngxPicaError);
            });
            nextFile_1.next(files[index_1]);
        }
        else {
            var ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            resizedImage.error(ngxPicaError);
            resizedImage.complete();
        }
        return resizedImage.asObservable();
    };
    NgxPicaService.prototype.resizeImage = function (file, width, height, options) {
        var _this = this;
        var resizedImage = new Subject();
        var originCanvas = document.createElement('canvas');
        var ctx = originCanvas.getContext('2d');
        var img = new Image();
        var reader = new FileReader();
        if (!options) {
            options = {
                exifOptions: {
                    forceExifOrientation: true
                }
            };
        }
        if (ctx) {
            reader.addEventListener('load', function (event) {
                img.onerror = function (err) {
                    resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                };
                img.onload = function () {
                    _this.processImageExifOptions(img, options.exifOptions)
                        .then(function (orientedImage) {
                        originCanvas.width = orientedImage.width;
                        originCanvas.height = orientedImage.height;
                        ctx.drawImage(orientedImage, 0, 0);
                        var imageData = ctx.getImageData(0, 0, orientedImage.width, orientedImage.height);
                        if (options && options.aspectRatio && options.aspectRatio.keepAspectRatio) {
                            var ratio = 0;
                            if (options.aspectRatio.forceMinDimensions) {
                                ratio = Math.max(width / imageData.width, height / imageData.height);
                            }
                            else {
                                ratio = Math.min(width / imageData.width, height / imageData.height);
                            }
                            width = Math.round(imageData.width * ratio);
                            height = Math.round(imageData.height * ratio);
                        }
                        var destinationCanvas = document.createElement('canvas');
                        destinationCanvas.width = width;
                        destinationCanvas.height = height;
                        _this.picaResize(file, originCanvas, destinationCanvas, options)
                            .catch(function (err) { return resizedImage.error(err); })
                            .then(function (imgResized) {
                            resizedImage.next(imgResized);
                            resizedImage.complete();
                        });
                    })
                        .catch(function (err) {
                        resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                    });
                };
                img.src = reader.result;
            });
            reader.readAsDataURL(file);
        }
        else {
            resizedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
        }
        return resizedImage.asObservable();
    };
    NgxPicaService.prototype.compressImages = function (files, sizeInMB, options) {
        var _this = this;
        var compressedImage = new Subject();
        var totalFiles = files.length;
        if (totalFiles > 0) {
            var nextFile_2 = new Subject();
            var index_2 = 0;
            var subscription_2 = nextFile_2
                .pipe(switchMap(function (file) { return _this.compressImage(file, sizeInMB, options); }))
                .subscribe(function (imageCompressed) {
                index_2++;
                compressedImage.next(imageCompressed);
                if (index_2 < totalFiles) {
                    nextFile_2.next(files[index_2]);
                }
                else {
                    compressedImage.complete();
                    subscription_2.unsubscribe();
                }
            }, function (err) {
                var ngxPicaError = {
                    file: files[index_2],
                    err: err
                };
                compressedImage.error(ngxPicaError);
            });
            nextFile_2.next(files[index_2]);
        }
        else {
            var ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            compressedImage.error(ngxPicaError);
            compressedImage.complete();
        }
        return compressedImage.asObservable();
    };
    NgxPicaService.prototype.compressImage = function (file, sizeInMB, options) {
        var _this = this;
        var compressedImage = new Subject();
        if (this.bytesToMB(file.size) <= sizeInMB) {
            setTimeout(function () {
                compressedImage.next(file);
                compressedImage.complete();
            });
        }
        else {
            var originCanvas_1 = document.createElement('canvas');
            var ctx_1 = originCanvas_1.getContext('2d');
            var img_1 = new Image();
            var reader_1 = new FileReader();
            if (!options) {
                options = {
                    exifOptions: {
                        forceExifOrientation: true
                    }
                };
            }
            if (ctx_1) {
                reader_1.addEventListener('load', function (event) {
                    img_1.onload = function () {
                        _this.processImageExifOptions(img_1, options.exifOptions)
                            .then(function (orientedImage) {
                            originCanvas_1.width = orientedImage.width;
                            originCanvas_1.height = orientedImage.height;
                            ctx_1.drawImage(orientedImage, 0, 0);
                            _this.getCompressedImage(originCanvas_1, file.type, 1, sizeInMB, 0)
                                .catch(function (err) { return compressedImage.error(err); })
                                .then(function (blob) {
                                var imgCompressed = _this.blobToFile(blob, file.name, file.type, new Date().getTime());
                                compressedImage.next(imgCompressed);
                                compressedImage.complete();
                            });
                        });
                    };
                    img_1.src = reader_1.result;
                });
                reader_1.readAsDataURL(file);
            }
            else {
                compressedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
            }
        }
        return compressedImage.asObservable();
    };
    NgxPicaService.prototype.processImageExifOptions = function (img, exifOptions) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (exifOptions.forceExifOrientation) {
                _this._ngxPicaExifService.getExifOrientedImage(img)
                    .then(function (orientedImage) { return resolve(orientedImage); })
                    .catch(function (err) { return reject(err); });
            }
            else {
                resolve(img);
            }
        });
    };
    NgxPicaService.prototype.getCompressedImage = function (canvas, type, quality, sizeInMB, step) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.picaResizer.toBlob(canvas, type, quality)
                .catch(function (err) { return reject(err); })
                .then(function (blob) {
                _this.checkCompressedImageSize(canvas, blob, quality, sizeInMB, step)
                    .catch(function (err) { return reject(err); })
                    .then(function (compressedBlob) {
                    resolve(compressedBlob);
                });
            });
        });
    };
    NgxPicaService.prototype.checkCompressedImageSize = function (canvas, blob, quality, sizeInMB, step) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (step > _this.MAX_STEPS) {
                reject(NgxPicaErrorType.NOT_BE_ABLE_TO_COMPRESS_ENOUGH);
            }
            else if (_this.bytesToMB(blob.size) < sizeInMB) {
                resolve(blob);
            }
            else {
                var newQuality = quality - (quality * 0.1);
                var newStep = step + 1;
                // recursively compression
                resolve(_this.getCompressedImage(canvas, blob.type, newQuality, sizeInMB, newStep));
            }
        });
    };
    NgxPicaService.prototype.picaResize = function (file, from, to, options) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.picaResizer.resize(from, to, options)
                .catch(function (err) { return reject(err); })
                .then(function (resizedCanvas) { return _this.picaResizer.toBlob(resizedCanvas, file.type); })
                .then(function (blob) {
                var fileResized = _this.blobToFile(blob, file.name, file.type, new Date().getTime());
                resolve(fileResized);
            });
        });
    };
    NgxPicaService.prototype.blobToFile = function (blob, name, type, lastModified) {
        return Object.assign(new Blob([blob], { type: type }), { name: name, lastModified: lastModified });
    };
    NgxPicaService.prototype.bytesToMB = function (bytes) {
        return bytes / 1048576;
    };
    NgxPicaService.ctorParameters = function () { return [
        { type: NgxPicaExifService }
    ]; };
    NgxPicaService = __decorate([ __metadata("design:paramtypes", [NgxPicaExifService])
    ], NgxPicaService);
NgxPicaService.ɵfac = function NgxPicaService_Factory(t) { return new (t || NgxPicaService)(ɵngcc0.ɵɵinject(NgxPicaExifService)); };
NgxPicaService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: NgxPicaService, factory: function (t) { return NgxPicaService.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NgxPicaService, [{
        type: Injectable
    }], function () { return [{ type: NgxPicaExifService }]; }, null); })();
    return NgxPicaService;
}());
export { NgxPicaService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBpY2Euc2VydmljZS5qcyIsInNvdXJjZXMiOlsibmc6L0BkaWdpdGFsYXNjZXRpYy9uZ3gtcGljYS9saWIvbmd4LXBpY2Euc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsT0FBTyxFQUEyQixNQUFNLE1BQU0sQ0FBQztBQUN2RCxPQUFPLEVBQXdCLGdCQUFnQixFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFNbkYsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDM0QsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFNekM7QUFDb0IsSUFHbEIsd0JBQW9CLG1CQUF1QztBQUM3RCxRQURzQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQW9CO0FBQUMsUUFIcEQsZ0JBQVcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ25DLFFBQVUsY0FBUyxHQUFHLEVBQUUsQ0FBQztBQUN6QixRQUVJLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUU7QUFDdkQsWUFBTSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzNDLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNTLHFDQUFZLEdBQW5CLFVBQW9CLEtBQWEsRUFBRSxLQUFhLEVBQUUsTUFBYyxFQUFFLE9BQXVDO0FBQUksUUFBN0csaUJBMkNDO0FBQ0gsUUEzQ0ksSUFBTSxZQUFZLEdBQWtCLElBQUksT0FBTyxFQUFFLENBQUM7QUFDdEQsUUFBSSxJQUFNLFVBQVUsR0FBVyxLQUFLLENBQUMsTUFBTSxDQUFDO0FBQzVDLFFBQ0ksSUFBSSxVQUFVLEdBQUcsQ0FBQyxFQUFFO0FB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elNhLGNBQWM7QUFDMUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtOZ3hQaWNhRXJyb3JJbnRlcmZhY2UsIE5neFBpY2FFcnJvclR5cGV9IGZyb20gJy4vbmd4LXBpY2EtZXJyb3IuaW50ZXJmYWNlJztcbmltcG9ydCB7XG4gIEV4aWZPcHRpb25zLFxuICBOZ3hQaWNhQ29tcHJlc3NPcHRpb25zSW50ZXJmYWNlLFxuICBOZ3hQaWNhUmVzaXplT3B0aW9uc0ludGVyZmFjZVxufSBmcm9tICcuL25neC1waWNhLXJlc2l6ZS1vcHRpb25zLmludGVyZmFjZSc7XG5pbXBvcnQge05neFBpY2FFeGlmU2VydmljZX0gZnJvbSAnLi9uZ3gtcGljYS1leGlmLnNlcnZpY2UnO1xuaW1wb3J0IFBpY2EgZnJvbSAncGljYSc7XG5pbXBvcnQge3N3aXRjaE1hcH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5cblxuZGVjbGFyZSBsZXQgd2luZG93OiBhbnk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3hQaWNhU2VydmljZSB7XG4gIHByaXZhdGUgcGljYVJlc2l6ZXIgPSBuZXcgUGljYSgpO1xuICBwcml2YXRlIE1BWF9TVEVQUyA9IDIwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX25neFBpY2FFeGlmU2VydmljZTogTmd4UGljYUV4aWZTZXJ2aWNlKSB7XG4gICAgaWYgKCF0aGlzLnBpY2FSZXNpemVyIHx8ICF0aGlzLnBpY2FSZXNpemVyLnJlc2l6ZSkge1xuICAgICAgdGhpcy5waWNhUmVzaXplciA9IG5ldyB3aW5kb3cuUGljYSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZXNpemVJbWFnZXMoZmlsZXM6IEZpbGVbXSwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIG9wdGlvbnM/OiBOZ3hQaWNhUmVzaXplT3B0aW9uc0ludGVyZmFjZSk6IE9ic2VydmFibGU8RmlsZT4ge1xuICAgIGNvbnN0IHJlc2l6ZWRJbWFnZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgY29uc3QgdG90YWxGaWxlczogbnVtYmVyID0gZmlsZXMubGVuZ3RoO1xuXG4gICAgaWYgKHRvdGFsRmlsZXMgPiAwKSB7XG4gICAgICBjb25zdCBuZXh0RmlsZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICBsZXQgaW5kZXggPSAwO1xuXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5leHRGaWxlXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoZmlsZTogRmlsZSkgPT4gdGhpcy5yZXNpemVJbWFnZShmaWxlLCB3aWR0aCwgaGVpZ2h0LCBvcHRpb25zKSlcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKGltYWdlUmVzaXplZCA9PiB7XG4gICAgICAgICAgaW5kZXgrKztcbiAgICAgICAgICByZXNpemVkSW1hZ2UubmV4dChpbWFnZVJlc2l6ZWQpO1xuXG4gICAgICAgICAgaWYgKGluZGV4IDwgdG90YWxGaWxlcykge1xuICAgICAgICAgICAgbmV4dEZpbGUubmV4dChmaWxlc1tpbmRleF0pO1xuXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc2l6ZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc3Qgbmd4UGljYUVycm9yOiBOZ3hQaWNhRXJyb3JJbnRlcmZhY2UgPSB7XG4gICAgICAgICAgICBmaWxlOiBmaWxlc1tpbmRleF0sXG4gICAgICAgICAgICBlcnI6IGVyclxuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXNpemVkSW1hZ2UuZXJyb3Iobmd4UGljYUVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIG5leHRGaWxlLm5leHQoZmlsZXNbaW5kZXhdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbmd4UGljYUVycm9yOiBOZ3hQaWNhRXJyb3JJbnRlcmZhY2UgPSB7XG4gICAgICAgIGVycjogTmd4UGljYUVycm9yVHlwZS5OT19GSUxFU19SRUNFSVZFRFxuICAgICAgfTtcblxuICAgICAgcmVzaXplZEltYWdlLmVycm9yKG5neFBpY2FFcnJvcik7XG4gICAgICByZXNpemVkSW1hZ2UuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzaXplZEltYWdlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIHJlc2l6ZUltYWdlKGZpbGU6IEZpbGUsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBvcHRpb25zPzogTmd4UGljYVJlc2l6ZU9wdGlvbnNJbnRlcmZhY2UpOiBPYnNlcnZhYmxlPEZpbGU+IHtcbiAgICBjb25zdCByZXNpemVkSW1hZ2U6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgIGNvbnN0IG9yaWdpbkNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICBjb25zdCBjdHggPSBvcmlnaW5DYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICBjb25zdCByZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuXG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICBvcHRpb25zID0ge1xuICAgICAgICBleGlmT3B0aW9uczoge1xuICAgICAgICAgIGZvcmNlRXhpZk9yaWVudGF0aW9uOiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGN0eCkge1xuICAgICAgcmVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICBpbWcub25lcnJvciA9IChlcnIpID0+IHtcbiAgICAgICAgICByZXNpemVkSW1hZ2UuZXJyb3Ioe2VycjogTmd4UGljYUVycm9yVHlwZS5SRUFEX0VSUk9SLCBmaWxlOiBmaWxlLCBvcmlnaW5hbF9lcnJvcjogZXJyfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NJbWFnZUV4aWZPcHRpb25zKGltZywgb3B0aW9ucy5leGlmT3B0aW9ucylcbiAgICAgICAgICAgIC50aGVuKG9yaWVudGVkSW1hZ2UgPT4ge1xuICAgICAgICAgICAgICBvcmlnaW5DYW52YXMud2lkdGggPSBvcmllbnRlZEltYWdlLndpZHRoO1xuICAgICAgICAgICAgICBvcmlnaW5DYW52YXMuaGVpZ2h0ID0gb3JpZW50ZWRJbWFnZS5oZWlnaHQ7XG5cbiAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShvcmllbnRlZEltYWdlLCAwLCAwKTtcblxuICAgICAgICAgICAgICBjb25zdCBpbWFnZURhdGEgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIG9yaWVudGVkSW1hZ2Uud2lkdGgsIG9yaWVudGVkSW1hZ2UuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5hc3BlY3RSYXRpbyAmJiBvcHRpb25zLmFzcGVjdFJhdGlvLmtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICAgICAgICAgIGxldCByYXRpbyA9IDA7XG5cbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5hc3BlY3RSYXRpby5mb3JjZU1pbkRpbWVuc2lvbnMpIHtcbiAgICAgICAgICAgICAgICAgIHJhdGlvID0gTWF0aC5tYXgod2lkdGggLyBpbWFnZURhdGEud2lkdGgsIGhlaWdodCAvIGltYWdlRGF0YS5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByYXRpbyA9IE1hdGgubWluKHdpZHRoIC8gaW1hZ2VEYXRhLndpZHRoLCBoZWlnaHQgLyBpbWFnZURhdGEuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB3aWR0aCA9IE1hdGgucm91bmQoaW1hZ2VEYXRhLndpZHRoICogcmF0aW8pO1xuICAgICAgICAgICAgICAgIGhlaWdodCA9IE1hdGgucm91bmQoaW1hZ2VEYXRhLmhlaWdodCAqIHJhdGlvKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICAgICAgICBkZXN0aW5hdGlvbkNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICAgICAgICBkZXN0aW5hdGlvbkNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG5cbiAgICAgICAgICAgICAgdGhpcy5waWNhUmVzaXplKGZpbGUsIG9yaWdpbkNhbnZhcywgZGVzdGluYXRpb25DYW52YXMsIG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlc2l6ZWRJbWFnZS5lcnJvcihlcnIpKVxuICAgICAgICAgICAgICAgIC50aGVuKChpbWdSZXNpemVkOiBGaWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgICByZXNpemVkSW1hZ2UubmV4dChpbWdSZXNpemVkKTtcbiAgICAgICAgICAgICAgICAgIHJlc2l6ZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgIHJlc2l6ZWRJbWFnZS5lcnJvcih7ZXJyOiBOZ3hQaWNhRXJyb3JUeXBlLlJFQURfRVJST1IsIGZpbGU6IGZpbGUsIG9yaWdpbmFsX2Vycm9yOiBlcnJ9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIGltZy5zcmMgPSA8c3RyaW5nPnJlYWRlci5yZXN1bHQ7XG4gICAgICB9KTtcblxuICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc2l6ZWRJbWFnZS5lcnJvcihOZ3hQaWNhRXJyb3JUeXBlLkNBTlZBU19DT05URVhUX0lERU5USUZJRVJfTk9UX1NVUFBPUlRFRCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc2l6ZWRJbWFnZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBjb21wcmVzc0ltYWdlcyhmaWxlczogRmlsZVtdLCBzaXplSW5NQjogbnVtYmVyLCBvcHRpb25zPzogTmd4UGljYUNvbXByZXNzT3B0aW9uc0ludGVyZmFjZSk6IE9ic2VydmFibGU8RmlsZT4ge1xuICAgIGNvbnN0IGNvbXByZXNzZWRJbWFnZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgY29uc3QgdG90YWxGaWxlczogbnVtYmVyID0gZmlsZXMubGVuZ3RoO1xuXG4gICAgaWYgKHRvdGFsRmlsZXMgPiAwKSB7XG4gICAgICBjb25zdCBuZXh0RmlsZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICBsZXQgaW5kZXggPSAwO1xuXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5leHRGaWxlXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoZmlsZTogRmlsZSkgPT4gdGhpcy5jb21wcmVzc0ltYWdlKGZpbGUsIHNpemVJbk1CLCBvcHRpb25zKSlcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKGltYWdlQ29tcHJlc3NlZCA9PiB7XG4gICAgICAgICAgaW5kZXgrKztcbiAgICAgICAgICBjb21wcmVzc2VkSW1hZ2UubmV4dChpbWFnZUNvbXByZXNzZWQpO1xuXG4gICAgICAgICAgaWYgKGluZGV4IDwgdG90YWxGaWxlcykge1xuICAgICAgICAgICAgbmV4dEZpbGUubmV4dChmaWxlc1tpbmRleF0pO1xuXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbXByZXNzZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc3Qgbmd4UGljYUVycm9yOiBOZ3hQaWNhRXJyb3JJbnRlcmZhY2UgPSB7XG4gICAgICAgICAgICBmaWxlOiBmaWxlc1tpbmRleF0sXG4gICAgICAgICAgICBlcnI6IGVyclxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBjb21wcmVzc2VkSW1hZ2UuZXJyb3Iobmd4UGljYUVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIG5leHRGaWxlLm5leHQoZmlsZXNbaW5kZXhdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbmd4UGljYUVycm9yOiBOZ3hQaWNhRXJyb3JJbnRlcmZhY2UgPSB7XG4gICAgICAgIGVycjogTmd4UGljYUVycm9yVHlwZS5OT19GSUxFU19SRUNFSVZFRFxuICAgICAgfTtcblxuICAgICAgY29tcHJlc3NlZEltYWdlLmVycm9yKG5neFBpY2FFcnJvcik7XG4gICAgICBjb21wcmVzc2VkSW1hZ2UuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tcHJlc3NlZEltYWdlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIGNvbXByZXNzSW1hZ2UoZmlsZTogRmlsZSwgc2l6ZUluTUI6IG51bWJlciwgb3B0aW9ucz86IE5neFBpY2FDb21wcmVzc09wdGlvbnNJbnRlcmZhY2UpOiBPYnNlcnZhYmxlPEZpbGU+IHtcbiAgICBjb25zdCBjb21wcmVzc2VkSW1hZ2U6IFN1YmplY3Q8RmlsZT4gPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgaWYgKHRoaXMuYnl0ZXNUb01CKGZpbGUuc2l6ZSkgPD0gc2l6ZUluTUIpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb21wcmVzc2VkSW1hZ2UubmV4dChmaWxlKTtcbiAgICAgICAgY29tcHJlc3NlZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuXG4gICAgICBjb25zdCBvcmlnaW5DYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICBjb25zdCBjdHggPSBvcmlnaW5DYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgY29uc3QgcmVhZGVyOiBGaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcblxuICAgICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgZXhpZk9wdGlvbnM6IHtcbiAgICAgICAgICAgIGZvcmNlRXhpZk9yaWVudGF0aW9uOiB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBpZiAoY3R4KSB7XG4gICAgICAgIHJlYWRlci5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW1hZ2VFeGlmT3B0aW9ucyhpbWcsIG9wdGlvbnMuZXhpZk9wdGlvbnMpXG4gICAgICAgICAgICAgIC50aGVuKG9yaWVudGVkSW1hZ2UgPT4ge1xuICAgICAgICAgICAgICAgIG9yaWdpbkNhbnZhcy53aWR0aCA9IG9yaWVudGVkSW1hZ2Uud2lkdGg7XG4gICAgICAgICAgICAgICAgb3JpZ2luQ2FudmFzLmhlaWdodCA9IG9yaWVudGVkSW1hZ2UuaGVpZ2h0O1xuXG4gICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShvcmllbnRlZEltYWdlLCAwLCAwKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q29tcHJlc3NlZEltYWdlKG9yaWdpbkNhbnZhcywgZmlsZS50eXBlLCAxLCBzaXplSW5NQiwgMClcbiAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBjb21wcmVzc2VkSW1hZ2UuZXJyb3IoZXJyKSlcbiAgICAgICAgICAgICAgICAgIC50aGVuKChibG9iOiBCbG9iKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGltZ0NvbXByZXNzZWQ6IEZpbGUgPSB0aGlzLmJsb2JUb0ZpbGUoYmxvYiwgZmlsZS5uYW1lLCBmaWxlLnR5cGUsIG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcblxuICAgICAgICAgICAgICAgICAgICBjb21wcmVzc2VkSW1hZ2UubmV4dChpbWdDb21wcmVzc2VkKTtcbiAgICAgICAgICAgICAgICAgICAgY29tcHJlc3NlZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGltZy5zcmMgPSA8c3RyaW5nPnJlYWRlci5yZXN1bHQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29tcHJlc3NlZEltYWdlLmVycm9yKE5neFBpY2FFcnJvclR5cGUuQ0FOVkFTX0NPTlRFWFRfSURFTlRJRklFUl9OT1RfU1VQUE9SVEVEKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY29tcHJlc3NlZEltYWdlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzSW1hZ2VFeGlmT3B0aW9ucyhpbWc6IEhUTUxJbWFnZUVsZW1lbnQsIGV4aWZPcHRpb25zOiBFeGlmT3B0aW9ucyk6IFByb21pc2U8SFRNTEltYWdlRWxlbWVudD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAoZXhpZk9wdGlvbnMuZm9yY2VFeGlmT3JpZW50YXRpb24pIHtcbiAgICAgICAgdGhpcy5fbmd4UGljYUV4aWZTZXJ2aWNlLmdldEV4aWZPcmllbnRlZEltYWdlKGltZylcbiAgICAgICAgICAudGhlbihvcmllbnRlZEltYWdlID0+IHJlc29sdmUob3JpZW50ZWRJbWFnZSkpXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKGltZyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldENvbXByZXNzZWRJbWFnZShjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LCB0eXBlOiBzdHJpbmcsIHF1YWxpdHk6IG51bWJlciwgc2l6ZUluTUI6IG51bWJlciwgc3RlcDogbnVtYmVyKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEJsb2I+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucGljYVJlc2l6ZXIudG9CbG9iKGNhbnZhcywgdHlwZSwgcXVhbGl0eSlcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgICAudGhlbigoYmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgIHRoaXMuY2hlY2tDb21wcmVzc2VkSW1hZ2VTaXplKGNhbnZhcywgYmxvYiwgcXVhbGl0eSwgc2l6ZUluTUIsIHN0ZXApXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpXG4gICAgICAgICAgICAudGhlbigoY29tcHJlc3NlZEJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGNvbXByZXNzZWRCbG9iKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrQ29tcHJlc3NlZEltYWdlU2l6ZShcbiAgICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LFxuICAgIGJsb2I6IEJsb2IsXG4gICAgcXVhbGl0eTogbnVtYmVyLFxuICAgIHNpemVJbk1COiBudW1iZXIsXG4gICAgc3RlcDogbnVtYmVyXG4gICk6IFByb21pc2U8QmxvYj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxCbG9iPigocmVzb2x2ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCkgPT4ge1xuXG4gICAgICBpZiAoc3RlcCA+IHRoaXMuTUFYX1NURVBTKSB7XG4gICAgICAgIHJlamVjdChOZ3hQaWNhRXJyb3JUeXBlLk5PVF9CRV9BQkxFX1RPX0NPTVBSRVNTX0VOT1VHSCk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuYnl0ZXNUb01CKGJsb2Iuc2l6ZSkgPCBzaXplSW5NQikge1xuICAgICAgICByZXNvbHZlKGJsb2IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgbmV3UXVhbGl0eTogbnVtYmVyID0gcXVhbGl0eSAtIChxdWFsaXR5ICogMC4xKTtcbiAgICAgICAgY29uc3QgbmV3U3RlcDogbnVtYmVyID0gc3RlcCArIDE7XG5cbiAgICAgICAgLy8gcmVjdXJzaXZlbHkgY29tcHJlc3Npb25cbiAgICAgICAgcmVzb2x2ZSh0aGlzLmdldENvbXByZXNzZWRJbWFnZShjYW52YXMsIGJsb2IudHlwZSwgbmV3UXVhbGl0eSwgc2l6ZUluTUIsIG5ld1N0ZXApKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcGljYVJlc2l6ZShmaWxlOiBGaWxlLCBmcm9tOiBIVE1MQ2FudmFzRWxlbWVudCwgdG86IEhUTUxDYW52YXNFbGVtZW50LCBvcHRpb25zOiBhbnkpOiBQcm9taXNlPEZpbGU+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8RmlsZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5waWNhUmVzaXplci5yZXNpemUoZnJvbSwgdG8sIG9wdGlvbnMpXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSlcbiAgICAgICAgLnRoZW4oKHJlc2l6ZWRDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KSA9PiB0aGlzLnBpY2FSZXNpemVyLnRvQmxvYihyZXNpemVkQ2FudmFzLCBmaWxlLnR5cGUpKVxuICAgICAgICAudGhlbigoYmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbGVSZXNpemVkOiBGaWxlID0gdGhpcy5ibG9iVG9GaWxlKGJsb2IsIGZpbGUubmFtZSwgZmlsZS50eXBlLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgICAgICAgcmVzb2x2ZShmaWxlUmVzaXplZCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBibG9iVG9GaWxlKGJsb2I6IEJsb2IsIG5hbWU6IHN0cmluZywgdHlwZTogc3RyaW5nLCBsYXN0TW9kaWZpZWQ6IG51bWJlcik6IEZpbGUge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyBCbG9iKFtibG9iXSwge3R5cGU6IHR5cGV9KSwge25hbWU6IG5hbWUsIGxhc3RNb2RpZmllZDogbGFzdE1vZGlmaWVkfSk7XG4gIH1cblxuICBwcml2YXRlIGJ5dGVzVG9NQihieXRlczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIGJ5dGVzIC8gMTA0ODU3NjtcbiAgfVxufVxuIl19