import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { NgxPicaErrorType } from './ngx-pica-error.interface';
import { NgxPicaExifService } from './ngx-pica-exif.service';
import Pica from 'pica';
import { switchMap } from "rxjs/operators";
let NgxPicaService = class NgxPicaService {
    constructor(_ngxPicaExifService) {
        this._ngxPicaExifService = _ngxPicaExifService;
        this.picaResizer = new Pica();
        this.MAX_STEPS = 20;
        if (!this.picaResizer || !this.picaResizer.resize) {
            this.picaResizer = new window.Pica();
        }
    }
    resizeImages(files, width, height, options) {
        const resizedImage = new Subject();
        const totalFiles = files.length;
        if (totalFiles > 0) {
            const nextFile = new Subject();
            let index = 0;
            const subscription = nextFile
                .pipe(switchMap((file) => this.resizeImage(file, width, height, options)))
                .subscribe(imageResized => {
                index++;
                resizedImage.next(imageResized);
                if (index < totalFiles) {
                    nextFile.next(files[index]);
                }
                else {
                    resizedImage.complete();
                    subscription.unsubscribe();
                }
            }, (err) => {
                const ngxPicaError = {
                    file: files[index],
                    err: err
                };
                resizedImage.error(ngxPicaError);
            });
            nextFile.next(files[index]);
        }
        else {
            const ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            resizedImage.error(ngxPicaError);
            resizedImage.complete();
        }
        return resizedImage.asObservable();
    }
    resizeImage(file, width, height, options) {
        const resizedImage = new Subject();
        const originCanvas = document.createElement('canvas');
        const ctx = originCanvas.getContext('2d');
        const img = new Image();
        const reader = new FileReader();
        if (!options) {
            options = {
                exifOptions: {
                    forceExifOrientation: true
                }
            };
        }
        if (ctx) {
            reader.addEventListener('load', (event) => {
                img.onerror = (err) => {
                    resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                };
                img.onload = () => {
                    this.processImageExifOptions(img, options.exifOptions)
                        .then(orientedImage => {
                        originCanvas.width = orientedImage.width;
                        originCanvas.height = orientedImage.height;
                        ctx.drawImage(orientedImage, 0, 0);
                        const imageData = ctx.getImageData(0, 0, orientedImage.width, orientedImage.height);
                        if (options && options.aspectRatio && options.aspectRatio.keepAspectRatio) {
                            let ratio = 0;
                            if (options.aspectRatio.forceMinDimensions) {
                                ratio = Math.max(width / imageData.width, height / imageData.height);
                            }
                            else {
                                ratio = Math.min(width / imageData.width, height / imageData.height);
                            }
                            width = Math.round(imageData.width * ratio);
                            height = Math.round(imageData.height * ratio);
                        }
                        const destinationCanvas = document.createElement('canvas');
                        destinationCanvas.width = width;
                        destinationCanvas.height = height;
                        this.picaResize(file, originCanvas, destinationCanvas, options)
                            .catch((err) => resizedImage.error(err))
                            .then((imgResized) => {
                            resizedImage.next(imgResized);
                            resizedImage.complete();
                        });
                    })
                        .catch((err) => {
                        resizedImage.error({ err: NgxPicaErrorType.READ_ERROR, file: file, original_error: err });
                    });
                };
                img.src = reader.result;
            });
            reader.readAsDataURL(file);
        }
        else {
            resizedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
        }
        return resizedImage.asObservable();
    }
    compressImages(files, sizeInMB, options) {
        const compressedImage = new Subject();
        const totalFiles = files.length;
        if (totalFiles > 0) {
            const nextFile = new Subject();
            let index = 0;
            const subscription = nextFile
                .pipe(switchMap((file) => this.compressImage(file, sizeInMB, options)))
                .subscribe(imageCompressed => {
                index++;
                compressedImage.next(imageCompressed);
                if (index < totalFiles) {
                    nextFile.next(files[index]);
                }
                else {
                    compressedImage.complete();
                    subscription.unsubscribe();
                }
            }, (err) => {
                const ngxPicaError = {
                    file: files[index],
                    err: err
                };
                compressedImage.error(ngxPicaError);
            });
            nextFile.next(files[index]);
        }
        else {
            const ngxPicaError = {
                err: NgxPicaErrorType.NO_FILES_RECEIVED
            };
            compressedImage.error(ngxPicaError);
            compressedImage.complete();
        }
        return compressedImage.asObservable();
    }
    compressImage(file, sizeInMB, options) {
        const compressedImage = new Subject();
        if (this.bytesToMB(file.size) <= sizeInMB) {
            setTimeout(() => {
                compressedImage.next(file);
                compressedImage.complete();
            });
        }
        else {
            const originCanvas = document.createElement('canvas');
            const ctx = originCanvas.getContext('2d');
            const img = new Image();
            const reader = new FileReader();
            if (!options) {
                options = {
                    exifOptions: {
                        forceExifOrientation: true
                    }
                };
            }
            if (ctx) {
                reader.addEventListener('load', (event) => {
                    img.onload = () => {
                        this.processImageExifOptions(img, options.exifOptions)
                            .then(orientedImage => {
                            originCanvas.width = orientedImage.width;
                            originCanvas.height = orientedImage.height;
                            ctx.drawImage(orientedImage, 0, 0);
                            this.getCompressedImage(originCanvas, file.type, 1, sizeInMB, 0)
                                .catch((err) => compressedImage.error(err))
                                .then((blob) => {
                                const imgCompressed = this.blobToFile(blob, file.name, file.type, new Date().getTime());
                                compressedImage.next(imgCompressed);
                                compressedImage.complete();
                            });
                        });
                    };
                    img.src = reader.result;
                });
                reader.readAsDataURL(file);
            }
            else {
                compressedImage.error(NgxPicaErrorType.CANVAS_CONTEXT_IDENTIFIER_NOT_SUPPORTED);
            }
        }
        return compressedImage.asObservable();
    }
    processImageExifOptions(img, exifOptions) {
        return new Promise((resolve, reject) => {
            if (exifOptions.forceExifOrientation) {
                this._ngxPicaExifService.getExifOrientedImage(img)
                    .then(orientedImage => resolve(orientedImage))
                    .catch(err => reject(err));
            }
            else {
                resolve(img);
            }
        });
    }
    getCompressedImage(canvas, type, quality, sizeInMB, step) {
        return new Promise((resolve, reject) => {
            this.picaResizer.toBlob(canvas, type, quality)
                .catch((err) => reject(err))
                .then((blob) => {
                this.checkCompressedImageSize(canvas, blob, quality, sizeInMB, step)
                    .catch((err) => reject(err))
                    .then((compressedBlob) => {
                    resolve(compressedBlob);
                });
            });
        });
    }
    checkCompressedImageSize(canvas, blob, quality, sizeInMB, step) {
        return new Promise((resolve, reject) => {
            if (step > this.MAX_STEPS) {
                reject(NgxPicaErrorType.NOT_BE_ABLE_TO_COMPRESS_ENOUGH);
            }
            else if (this.bytesToMB(blob.size) < sizeInMB) {
                resolve(blob);
            }
            else {
                const newQuality = quality - (quality * 0.1);
                const newStep = step + 1;
                // recursively compression
                resolve(this.getCompressedImage(canvas, blob.type, newQuality, sizeInMB, newStep));
            }
        });
    }
    picaResize(file, from, to, options) {
        return new Promise((resolve, reject) => {
            this.picaResizer.resize(from, to, options)
                .catch((err) => reject(err))
                .then((resizedCanvas) => this.picaResizer.toBlob(resizedCanvas, file.type))
                .then((blob) => {
                const fileResized = this.blobToFile(blob, file.name, file.type, new Date().getTime());
                resolve(fileResized);
            });
        });
    }
    blobToFile(blob, name, type, lastModified) {
        return Object.assign(new Blob([blob], { type: type }), { name: name, lastModified: lastModified });
    }
    bytesToMB(bytes) {
        return bytes / 1048576;
    }
};
NgxPicaService.ctorParameters = () => [
    { type: NgxPicaExifService }
];
NgxPicaService = __decorate([
    Injectable(),
    __metadata("design:paramtypes", [NgxPicaExifService])
], NgxPicaService);
export { NgxPicaService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBpY2Euc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkaWdpdGFsYXNjZXRpYy9uZ3gtcGljYS8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtcGljYS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxPQUFPLEVBQTJCLE1BQU0sTUFBTSxDQUFDO0FBQ3ZELE9BQU8sRUFBd0IsZ0JBQWdCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQU1uRixPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBTXpDLElBQWEsY0FBYyxHQUEzQixNQUFhLGNBQWM7SUFJekIsWUFBb0IsbUJBQXVDO1FBQXZDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBb0I7UUFIbkQsZ0JBQVcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3pCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFHckIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUNqRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQztJQUVNLFlBQVksQ0FBQyxLQUFhLEVBQUUsS0FBYSxFQUFFLE1BQWMsRUFBRSxPQUF1QztRQUN2RyxNQUFNLFlBQVksR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNsRCxNQUFNLFVBQVUsR0FBVyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBRXhDLElBQUksVUFBVSxHQUFHLENBQUMsRUFBRTtZQUNsQixNQUFNLFFBQVEsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUM5QyxJ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O1lBQ3ZCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sVUFBVSxDQUFDLElBQVUsRUFBRSxJQUFZLEVBQUUsSUFBWSxFQUFFLFlBQW9CO1FBQzdFLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxDQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDO0lBQ2pHLENBQUM7SUFFTyxTQUFTLENBQUMsS0FBYTtRQUM3QixPQUFPLEtBQUssR0FBRyxPQUFPLENBQUM7SUFDekIsQ0FBQztDQUNGLENBQUE7O1lBcFMwQyxrQkFBa0I7O0FBSmhELGNBQWM7SUFEMUIsVUFBVSxFQUFFO3FDQUs4QixrQkFBa0I7R0FKaEQsY0FBYyxDQXdTMUI7U0F4U1ksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1N1YmplY3QsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge05neFBpY2FFcnJvckludGVyZmFjZSwgTmd4UGljYUVycm9yVHlwZX0gZnJvbSAnLi9uZ3gtcGljYS1lcnJvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgRXhpZk9wdGlvbnMsXG4gIE5neFBpY2FDb21wcmVzc09wdGlvbnNJbnRlcmZhY2UsXG4gIE5neFBpY2FSZXNpemVPcHRpb25zSW50ZXJmYWNlXG59IGZyb20gJy4vbmd4LXBpY2EtcmVzaXplLW9wdGlvbnMuaW50ZXJmYWNlJztcbmltcG9ydCB7Tmd4UGljYUV4aWZTZXJ2aWNlfSBmcm9tICcuL25neC1waWNhLWV4aWYuc2VydmljZSc7XG5pbXBvcnQgUGljYSBmcm9tICdwaWNhJztcbmltcG9ydCB7c3dpdGNoTWFwfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcblxuXG5kZWNsYXJlIGxldCB3aW5kb3c6IGFueTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5neFBpY2FTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBwaWNhUmVzaXplciA9IG5ldyBQaWNhKCk7XG4gIHByaXZhdGUgTUFYX1NURVBTID0gMjA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfbmd4UGljYUV4aWZTZXJ2aWNlOiBOZ3hQaWNhRXhpZlNlcnZpY2UpIHtcbiAgICBpZiAoIXRoaXMucGljYVJlc2l6ZXIgfHwgIXRoaXMucGljYVJlc2l6ZXIucmVzaXplKSB7XG4gICAgICB0aGlzLnBpY2FSZXNpemVyID0gbmV3IHdpbmRvdy5QaWNhKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlc2l6ZUltYWdlcyhmaWxlczogRmlsZVtdLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgb3B0aW9ucz86IE5neFBpY2FSZXNpemVPcHRpb25zSW50ZXJmYWNlKTogT2JzZXJ2YWJsZTxGaWxlPiB7XG4gICAgY29uc3QgcmVzaXplZEltYWdlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBjb25zdCB0b3RhbEZpbGVzOiBudW1iZXIgPSBmaWxlcy5sZW5ndGg7XG5cbiAgICBpZiAodG90YWxGaWxlcyA+IDApIHtcbiAgICAgIGNvbnN0IG5leHRGaWxlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgICAgIGxldCBpbmRleCA9IDA7XG5cbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbmV4dEZpbGVcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChmaWxlOiBGaWxlKSA9PiB0aGlzLnJlc2l6ZUltYWdlKGZpbGUsIHdpZHRoLCBoZWlnaHQsIG9wdGlvbnMpKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoaW1hZ2VSZXNpemVkID0+IHtcbiAgICAgICAgICBpbmRleCsrO1xuICAgICAgICAgIHJlc2l6ZWRJbWFnZS5uZXh0KGltYWdlUmVzaXplZCk7XG5cbiAgICAgICAgICBpZiAoaW5kZXggPCB0b3RhbEZpbGVzKSB7XG4gICAgICAgICAgICBuZXh0RmlsZS5uZXh0KGZpbGVzW2luZGV4XSk7XG5cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzaXplZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zdCBuZ3hQaWNhRXJyb3I6IE5neFBpY2FFcnJvckludGVyZmFjZSA9IHtcbiAgICAgICAgICAgIGZpbGU6IGZpbGVzW2luZGV4XSxcbiAgICAgICAgICAgIGVycjogZXJyXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJlc2l6ZWRJbWFnZS5lcnJvcihuZ3hQaWNhRXJyb3IpO1xuICAgICAgICB9KTtcblxuICAgICAgbmV4dEZpbGUubmV4dChmaWxlc1tpbmRleF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZ3hQaWNhRXJyb3I6IE5neFBpY2FFcnJvckludGVyZmFjZSA9IHtcbiAgICAgICAgZXJyOiBOZ3hQaWNhRXJyb3JUeXBlLk5PX0ZJTEVTX1JFQ0VJVkVEXG4gICAgICB9O1xuXG4gICAgICByZXNpemVkSW1hZ2UuZXJyb3Iobmd4UGljYUVycm9yKTtcbiAgICAgIHJlc2l6ZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNpemVkSW1hZ2UuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwdWJsaWMgcmVzaXplSW1hZ2UoZmlsZTogRmlsZSwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIG9wdGlvbnM/OiBOZ3hQaWNhUmVzaXplT3B0aW9uc0ludGVyZmFjZSk6IE9ic2VydmFibGU8RmlsZT4ge1xuICAgIGNvbnN0IHJlc2l6ZWRJbWFnZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgY29uc3Qgb3JpZ2luQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGNvbnN0IGN0eCA9IG9yaWdpbkNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGNvbnN0IHJlYWRlcjogRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG5cbiAgICBpZiAoIW9wdGlvbnMpIHtcbiAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgIGV4aWZPcHRpb25zOiB7XG4gICAgICAgICAgZm9yY2VFeGlmT3JpZW50YXRpb246IHRydWVcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoY3R4KSB7XG4gICAgICByZWFkZXIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIChldmVudDogYW55KSA9PiB7XG4gICAgICAgIGltZy5vbmVycm9yID0gKGVycikgPT4ge1xuICAgICAgICAgIHJlc2l6ZWRJbWFnZS5lcnJvcih7ZXJyOiBOZ3hQaWNhRXJyb3JUeXBlLlJFQURfRVJST1IsIGZpbGU6IGZpbGUsIG9yaWdpbmFsX2Vycm9yOiBlcnJ9KTtcbiAgICAgICAgfTtcblxuICAgICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIHRoaXMucHJvY2Vzc0ltYWdlRXhpZk9wdGlvbnMoaW1nLCBvcHRpb25zLmV4aWZPcHRpb25zKVxuICAgICAgICAgICAgLnRoZW4ob3JpZW50ZWRJbWFnZSA9PiB7XG4gICAgICAgICAgICAgIG9yaWdpbkNhbnZhcy53aWR0aCA9IG9yaWVudGVkSW1hZ2Uud2lkdGg7XG4gICAgICAgICAgICAgIG9yaWdpbkNhbnZhcy5oZWlnaHQgPSBvcmllbnRlZEltYWdlLmhlaWdodDtcblxuICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKG9yaWVudGVkSW1hZ2UsIDAsIDApO1xuXG4gICAgICAgICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgb3JpZW50ZWRJbWFnZS53aWR0aCwgb3JpZW50ZWRJbWFnZS5oZWlnaHQpO1xuICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmFzcGVjdFJhdGlvICYmIG9wdGlvbnMuYXNwZWN0UmF0aW8ua2VlcEFzcGVjdFJhdGlvKSB7XG4gICAgICAgICAgICAgICAgbGV0IHJhdGlvID0gMDtcblxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmFzcGVjdFJhdGlvLmZvcmNlTWluRGltZW5zaW9ucykge1xuICAgICAgICAgICAgICAgICAgcmF0aW8gPSBNYXRoLm1heCh3aWR0aCAvIGltYWdlRGF0YS53aWR0aCwgaGVpZ2h0IC8gaW1hZ2VEYXRhLmhlaWdodCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJhdGlvID0gTWF0aC5taW4od2lkdGggLyBpbWFnZURhdGEud2lkdGgsIGhlaWdodCAvIGltYWdlRGF0YS5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHdpZHRoID0gTWF0aC5yb3VuZChpbWFnZURhdGEud2lkdGggKiByYXRpbyk7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gTWF0aC5yb3VuZChpbWFnZURhdGEuaGVpZ2h0ICogcmF0aW8pO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29uc3QgZGVzdGluYXRpb25DYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgICAgICAgIGRlc3RpbmF0aW9uQ2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgICAgICAgICAgIGRlc3RpbmF0aW9uQ2FudmFzLmhlaWdodCA9IGhlaWdodDtcblxuICAgICAgICAgICAgICB0aGlzLnBpY2FSZXNpemUoZmlsZSwgb3JpZ2luQ2FudmFzLCBkZXN0aW5hdGlvbkNhbnZhcywgb3B0aW9ucylcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVzaXplZEltYWdlLmVycm9yKGVycikpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGltZ1Jlc2l6ZWQ6IEZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIHJlc2l6ZWRJbWFnZS5uZXh0KGltZ1Jlc2l6ZWQpO1xuICAgICAgICAgICAgICAgICAgcmVzaXplZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgcmVzaXplZEltYWdlLmVycm9yKHtlcnI6IE5neFBpY2FFcnJvclR5cGUuUkVBRF9FUlJPUiwgZmlsZTogZmlsZSwgb3JpZ2luYWxfZXJyb3I6IGVycn0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgaW1nLnNyYyA9IDxzdHJpbmc+cmVhZGVyLnJlc3VsdDtcbiAgICAgIH0pO1xuXG4gICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzaXplZEltYWdlLmVycm9yKE5neFBpY2FFcnJvclR5cGUuQ0FOVkFTX0NPTlRFWFRfSURFTlRJRklFUl9OT1RfU1VQUE9SVEVEKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzaXplZEltYWdlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIGNvbXByZXNzSW1hZ2VzKGZpbGVzOiBGaWxlW10sIHNpemVJbk1COiBudW1iZXIsIG9wdGlvbnM/OiBOZ3hQaWNhQ29tcHJlc3NPcHRpb25zSW50ZXJmYWNlKTogT2JzZXJ2YWJsZTxGaWxlPiB7XG4gICAgY29uc3QgY29tcHJlc3NlZEltYWdlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBjb25zdCB0b3RhbEZpbGVzOiBudW1iZXIgPSBmaWxlcy5sZW5ndGg7XG5cbiAgICBpZiAodG90YWxGaWxlcyA+IDApIHtcbiAgICAgIGNvbnN0IG5leHRGaWxlOiBTdWJqZWN0PEZpbGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgICAgIGxldCBpbmRleCA9IDA7XG5cbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbmV4dEZpbGVcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChmaWxlOiBGaWxlKSA9PiB0aGlzLmNvbXByZXNzSW1hZ2UoZmlsZSwgc2l6ZUluTUIsIG9wdGlvbnMpKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoaW1hZ2VDb21wcmVzc2VkID0+IHtcbiAgICAgICAgICBpbmRleCsrO1xuICAgICAgICAgIGNvbXByZXNzZWRJbWFnZS5uZXh0KGltYWdlQ29tcHJlc3NlZCk7XG5cbiAgICAgICAgICBpZiAoaW5kZXggPCB0b3RhbEZpbGVzKSB7XG4gICAgICAgICAgICBuZXh0RmlsZS5uZXh0KGZpbGVzW2luZGV4XSk7XG5cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29tcHJlc3NlZEltYWdlLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zdCBuZ3hQaWNhRXJyb3I6IE5neFBpY2FFcnJvckludGVyZmFjZSA9IHtcbiAgICAgICAgICAgIGZpbGU6IGZpbGVzW2luZGV4XSxcbiAgICAgICAgICAgIGVycjogZXJyXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGNvbXByZXNzZWRJbWFnZS5lcnJvcihuZ3hQaWNhRXJyb3IpO1xuICAgICAgICB9KTtcblxuICAgICAgbmV4dEZpbGUubmV4dChmaWxlc1tpbmRleF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZ3hQaWNhRXJyb3I6IE5neFBpY2FFcnJvckludGVyZmFjZSA9IHtcbiAgICAgICAgZXJyOiBOZ3hQaWNhRXJyb3JUeXBlLk5PX0ZJTEVTX1JFQ0VJVkVEXG4gICAgICB9O1xuXG4gICAgICBjb21wcmVzc2VkSW1hZ2UuZXJyb3Iobmd4UGljYUVycm9yKTtcbiAgICAgIGNvbXByZXNzZWRJbWFnZS5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIHJldHVybiBjb21wcmVzc2VkSW1hZ2UuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwdWJsaWMgY29tcHJlc3NJbWFnZShmaWxlOiBGaWxlLCBzaXplSW5NQjogbnVtYmVyLCBvcHRpb25zPzogTmd4UGljYUNvbXByZXNzT3B0aW9uc0ludGVyZmFjZSk6IE9ic2VydmFibGU8RmlsZT4ge1xuICAgIGNvbnN0IGNvbXByZXNzZWRJbWFnZTogU3ViamVjdDxGaWxlPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBpZiAodGhpcy5ieXRlc1RvTUIoZmlsZS5zaXplKSA8PSBzaXplSW5NQikge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbXByZXNzZWRJbWFnZS5uZXh0KGZpbGUpO1xuICAgICAgICBjb21wcmVzc2VkSW1hZ2UuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG5cbiAgICAgIGNvbnN0IG9yaWdpbkNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgIGNvbnN0IGN0eCA9IG9yaWdpbkNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG4gICAgICBjb25zdCByZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuXG4gICAgICBpZiAoIW9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICBleGlmT3B0aW9uczoge1xuICAgICAgICAgICAgZm9yY2VFeGlmT3JpZW50YXRpb246IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChjdHgpIHtcbiAgICAgICAgcmVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NJbWFnZUV4aWZPcHRpb25zKGltZywgb3B0aW9ucy5leGlmT3B0aW9ucylcbiAgICAgICAgICAgICAgLnRoZW4ob3JpZW50ZWRJbWFnZSA9PiB7XG4gICAgICAgICAgICAgICAgb3JpZ2luQ2FudmFzLndpZHRoID0gb3JpZW50ZWRJbWFnZS53aWR0aDtcbiAgICAgICAgICAgICAgICBvcmlnaW5DYW52YXMuaGVpZ2h0ID0gb3JpZW50ZWRJbWFnZS5oZWlnaHQ7XG5cbiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKG9yaWVudGVkSW1hZ2UsIDAsIDApO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRDb21wcmVzc2VkSW1hZ2Uob3JpZ2luQ2FudmFzLCBmaWxlLnR5cGUsIDEsIHNpemVJbk1CLCAwKVxuICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IGNvbXByZXNzZWRJbWFnZS5lcnJvcihlcnIpKVxuICAgICAgICAgICAgICAgICAgLnRoZW4oKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1nQ29tcHJlc3NlZDogRmlsZSA9IHRoaXMuYmxvYlRvRmlsZShibG9iLCBmaWxlLm5hbWUsIGZpbGUudHlwZSwgbmV3IERhdGUoKS5nZXRUaW1lKCkpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbXByZXNzZWRJbWFnZS5uZXh0KGltZ0NvbXByZXNzZWQpO1xuICAgICAgICAgICAgICAgICAgICBjb21wcmVzc2VkSW1hZ2UuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgaW1nLnNyYyA9IDxzdHJpbmc+cmVhZGVyLnJlc3VsdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb21wcmVzc2VkSW1hZ2UuZXJyb3IoTmd4UGljYUVycm9yVHlwZS5DQU5WQVNfQ09OVEVYVF9JREVOVElGSUVSX05PVF9TVVBQT1JURUQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb21wcmVzc2VkSW1hZ2UuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NJbWFnZUV4aWZPcHRpb25zKGltZzogSFRNTEltYWdlRWxlbWVudCwgZXhpZk9wdGlvbnM6IEV4aWZPcHRpb25zKTogUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEhUTUxJbWFnZUVsZW1lbnQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmIChleGlmT3B0aW9ucy5mb3JjZUV4aWZPcmllbnRhdGlvbikge1xuICAgICAgICB0aGlzLl9uZ3hQaWNhRXhpZlNlcnZpY2UuZ2V0RXhpZk9yaWVudGVkSW1hZ2UoaW1nKVxuICAgICAgICAgIC50aGVuKG9yaWVudGVkSW1hZ2UgPT4gcmVzb2x2ZShvcmllbnRlZEltYWdlKSlcbiAgICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoaW1nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcHJlc3NlZEltYWdlKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIHR5cGU6IHN0cmluZywgcXVhbGl0eTogbnVtYmVyLCBzaXplSW5NQjogbnVtYmVyLCBzdGVwOiBudW1iZXIpOiBQcm9taXNlPEJsb2I+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8QmxvYj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5waWNhUmVzaXplci50b0Jsb2IoY2FudmFzLCB0eXBlLCBxdWFsaXR5KVxuICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpXG4gICAgICAgIC50aGVuKChibG9iOiBCbG9iKSA9PiB7XG4gICAgICAgICAgdGhpcy5jaGVja0NvbXByZXNzZWRJbWFnZVNpemUoY2FudmFzLCBibG9iLCBxdWFsaXR5LCBzaXplSW5NQiwgc3RlcClcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSlcbiAgICAgICAgICAgIC50aGVuKChjb21wcmVzc2VkQmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoY29tcHJlc3NlZEJsb2IpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tDb21wcmVzc2VkSW1hZ2VTaXplKFxuICAgIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsXG4gICAgYmxvYjogQmxvYixcbiAgICBxdWFsaXR5OiBudW1iZXIsXG4gICAgc2l6ZUluTUI6IG51bWJlcixcbiAgICBzdGVwOiBudW1iZXJcbiAgKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEJsb2I+KChyZXNvbHZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KSA9PiB7XG5cbiAgICAgIGlmIChzdGVwID4gdGhpcy5NQVhfU1RFUFMpIHtcbiAgICAgICAgcmVqZWN0KE5neFBpY2FFcnJvclR5cGUuTk9UX0JFX0FCTEVfVE9fQ09NUFJFU1NfRU5PVUdIKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5ieXRlc1RvTUIoYmxvYi5zaXplKSA8IHNpemVJbk1CKSB7XG4gICAgICAgIHJlc29sdmUoYmxvYik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBuZXdRdWFsaXR5OiBudW1iZXIgPSBxdWFsaXR5IC0gKHF1YWxpdHkgKiAwLjEpO1xuICAgICAgICBjb25zdCBuZXdTdGVwOiBudW1iZXIgPSBzdGVwICsgMTtcblxuICAgICAgICAvLyByZWN1cnNpdmVseSBjb21wcmVzc2lvblxuICAgICAgICByZXNvbHZlKHRoaXMuZ2V0Q29tcHJlc3NlZEltYWdlKGNhbnZhcywgYmxvYi50eXBlLCBuZXdRdWFsaXR5LCBzaXplSW5NQiwgbmV3U3RlcCkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBwaWNhUmVzaXplKGZpbGU6IEZpbGUsIGZyb206IEhUTUxDYW52YXNFbGVtZW50LCB0bzogSFRNTENhbnZhc0VsZW1lbnQsIG9wdGlvbnM6IGFueSk6IFByb21pc2U8RmlsZT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxGaWxlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnBpY2FSZXNpemVyLnJlc2l6ZShmcm9tLCB0bywgb3B0aW9ucylcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgICAudGhlbigocmVzaXplZENhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpID0+IHRoaXMucGljYVJlc2l6ZXIudG9CbG9iKHJlc2l6ZWRDYW52YXMsIGZpbGUudHlwZSkpXG4gICAgICAgIC50aGVuKChibG9iOiBCbG9iKSA9PiB7XG4gICAgICAgICAgY29uc3QgZmlsZVJlc2l6ZWQ6IEZpbGUgPSB0aGlzLmJsb2JUb0ZpbGUoYmxvYiwgZmlsZS5uYW1lLCBmaWxlLnR5cGUsIG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgICAgICAgICByZXNvbHZlKGZpbGVSZXNpemVkKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGJsb2JUb0ZpbGUoYmxvYjogQmxvYiwgbmFtZTogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGxhc3RNb2RpZmllZDogbnVtYmVyKTogRmlsZSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IEJsb2IoW2Jsb2JdLCB7dHlwZTogdHlwZX0pLCB7bmFtZTogbmFtZSwgbGFzdE1vZGlmaWVkOiBsYXN0TW9kaWZpZWR9KTtcbiAgfVxuXG4gIHByaXZhdGUgYnl0ZXNUb01CKGJ5dGVzOiBudW1iZXIpIHtcbiAgICByZXR1cm4gYnl0ZXMgLyAxMDQ4NTc2O1xuICB9XG59XG4iXX0=